<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CGH Technik Planer</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #208085; --primary-dark: #1a6770; --admin: #c01530; --admin-dark: #a01229;
      --user: #22a344; --user-dark: #1a8637; --bg: #f5f5f5; --surface: #ffffff;
      --text: #1a1a1a; --text-light: #666; --border: #e0e0e0;
      --success: #22a344; --warning: #f0a500; --error: #c01530;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .login-container { max-width: 420px; margin: 80px auto; padding: 40px; background: var(--surface); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); text-align: center; }
    .login-container h1 { font-size: 32px; margin-bottom: 10px; background: linear-gradient(135deg, var(--primary), var(--admin)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .login-container p { color: var(--text-light); margin-bottom: 20px; }
    .form-group { margin-bottom: 20px; text-align: left; }
    label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px; }
    input, select, textarea { width: 100%; padding: 12px 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; font-family: inherit; transition: all 0.3s ease; }
    textarea { resize: vertical; min-height: 80px; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(32,128,133,0.1); }
    input:disabled, textarea:disabled { background: #f0f0f0; cursor: not-allowed; opacity: 0.6; }
    .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(32,128,133,0.3); }
    .btn-success { background: var(--success); color: #fff; }
    .btn-success:hover { background: var(--user-dark); }
    .btn-danger { background: var(--error); color: #fff; }
    .btn-danger:hover { background: var(--admin-dark); }
    .btn-small { padding: 8px 12px; font-size: 13px; width: auto; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .header { padding: 30px 20px; border-radius: 12px; color: white; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .header-admin { background: linear-gradient(135deg, var(--admin), var(--admin-dark)); }
    .header-user { background: linear-gradient(135deg, var(--user), var(--user-dark)); }
    .header h1 { margin: 0; font-size: 28px; }
    .header p { margin: 5px 0 0 0; opacity: 0.95; }
    .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; margin-left: 10px; background: rgba(255,255,255,0.2); }
    .section { background: var(--surface); padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .section h2 { font-size: 20px; margin-bottom: 20px; }
    .section h3 { font-size: 16px; margin-bottom: 15px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .form-row.three { grid-template-columns: 1fr 1fr 1fr; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th { background: #f8f9fa; padding: 12px 15px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border); font-size: 13px; text-transform: uppercase; }
    td { padding: 12px 15px; border-bottom: 1px solid var(--border); }
    tr:hover { background: #fafafa; }
    .response-cell { text-align: center; font-weight: 600; font-size: 18px; }
    .color-row { display: flex; gap: 10px; margin: 15px 0; justify-content: center; }
    .color-option { width: 40px; height: 40px; border-radius: 8px; cursor: pointer; border: 3px solid transparent; transition: all 0.3s ease; position: relative; user-select: none; }
    .color-option:hover { transform: scale(1.1); }
    .color-option.selected::after { content: "✓"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 22px; font-weight: 900; color: #000; }
    .color-option[aria-disabled="true"] { opacity: 0.6; cursor: not-allowed; }
    .color-red { background: #ffcdd2; border-color: #ef5350; }
    .color-yellow { background: #fff9c4; border-color: #fbc02d; }
    .color-green { background: #c8e6c9; border-color: #43a047; }
    .tech-card { background: var(--surface); border: 2px solid var(--border); padding: 15px; border-radius: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; }
    .tech-card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(32,128,133,0.15); }
    .tech-info { flex: 1; }
    .tech-info h4 { margin: 0 0 5px 0; font-size: 16px; }
    .tech-info p { margin: 3px 0; font-size: 13px; color: var(--text-light); }
    .role-badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-right: 5px; background: var(--primary); color: white; }
    .button-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    .button-group .btn { flex: 1; min-width: 150px; }
    .info-box { background: #e3f2fd; border-left: 4px solid var(--primary); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .info-box p { margin: 0; color: #1565c0; font-size: 14px; }
    .comment-box { background: #f9f9f9; border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--primary); }
    .comment-box strong { display: block; margin-bottom: 8px; color: var(--primary); }
    .comment-box p { margin: 0; font-size: 13px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
    .fatal { max-width: 1000px; margin: 40px auto; background: #fff; padding: 20px; border-radius: 12px; border: 2px solid var(--error); }
    .fatal pre { white-space: pre-wrap; background: #f7f7f7; padding: 10px; border-radius: 8px; overflow: auto; margin-top: 10px; }
    .date-cell { font-weight: 600; background: #f8f9fa; }
    .plan-table { overflow-x: auto; }
    @media (max-width: 768px) {
      .form-row { grid-template-columns: 1fr; }
      .form-row.three { grid-template-columns: 1fr; }
      .container { padding: 10px; }
      .login-container { margin: 40px auto; }
      .section { padding: 15px; }
      .tech-card { flex-direction: column; align-items: flex-start; }
      .button-group { flex-direction: column; }
      .button-group .btn { min-width: auto; }
      table { font-size: 13px; }
      th, td { padding: 8px 10px; }
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
    const SUPABASEURL = "https://orcpugfqltiljnvlitsn.supabase.co";
    const SUPABASEKEY = "sb_publishable_Bmkzy_E73Vjn4ySDK3cl2w_d4h1VKgl";
    const { createClient } = supabase;
    const sb = createClient(SUPABASEURL, SUPABASEKEY);
    const elApp = document.getElementById("app");

    window.onerror = (msg, src, line, col) => {
      if (!elApp) return;
      elApp.innerHTML = `<div class="fatal"><h2 style="color:var(--error)">Fehler</h2><pre>${msg}\n${src}:${line}:${col}</pre></div>`;
      return true;
    };

    const STATE = { user: null, profile: null, plan: null, planSundays: [], technicians: [], responses: {}, assignments: {}, techComments: {} };
    const fmtDateDE = (d) => new Date(d + "T12:00:00").toLocaleDateString("de-DE");
    const toast = (m) => alert(m);

    async function safeLoadSession() {
      try {
        const { data, error } = await sb.auth.getSession();
        if (error) throw error;
        STATE.user = data.session?.user || null;
      } catch (e) {
        await sb.auth.signOut();
        STATE.user = null;
      }
    }

    async function fetchMyProfile() {
      if (!STATE.user) return null;
      const { data, error } = await sb.from("profiles").select("id,email,name,role,approved,tech_role").eq("id", STATE.user.id).maybeSingle();
      if (error) throw error;
      STATE.profile = data;
      return STATE.profile;
    }

    async function fetchCurrentPlan(isAdmin) {
      let q = sb.from("plans").select("id,status,created_by,published,admin_comment,avail_open").order("created_at", { ascending: false }).limit(1);
      if (!isAdmin) q = q.eq("published", true);
      const { data, error } = await q;
      if (error) throw error;
      STATE.plan = (data?.length) ? data[0] : null;
      if (!STATE.plan) { STATE.planSundays = []; return null; }
      const { data: sundays, error: e2 } = await sb.from("plansundays").select("sunday").eq("planid", STATE.plan.id).order("sunday", { ascending: true });
      if (e2) throw e2;
      STATE.planSundays = (sundays || []).map(x => x.sunday);
      return STATE.plan;
    }

    async function fetchTechnicians() {
      const { data, error } = await sb.from("profiles").select("id,email,name,role,approved,tech_role").eq("role", "tech").order("email", { ascending: true });
      if (error) throw error;
      STATE.technicians = data || [];
    }

    async function fetchResponsesAndAssignments() {
      if (!STATE.plan) { STATE.responses = {}; STATE.assignments = {}; STATE.techComments = {}; return; }
      const { data: resp, error: e1 } = await sb.from("responses").select("techid,sunday,response,techcomment").eq("planid", STATE.plan.id);
      if (e1) throw e1;
      const respMap = {}, commMap = {};
      (resp || []).forEach(r => {
        if (!respMap[r.techid]) respMap[r.techid] = {};
        if (!commMap[r.techid]) commMap[r.techid] = {};
        respMap[r.techid][r.sunday] = r.response;
        commMap[r.techid][r.sunday] = r.techcomment || "";
      });
      STATE.responses = respMap;
      STATE.techComments = commMap;
      const { data: asg, error: e2 } = await sb.from("assignments").select("sunday,techids").eq("planid", STATE.plan.id);
      if (e2) throw e2;
      const asgMap = {};
      (asg || []).forEach(a => { asgMap[a.sunday] = a.techids || []; });
      STATE.assignments = asgMap;
    }

    function renderLogin() {
      elApp.innerHTML = `<div class="login-container"><h1>CGH Technik</h1><p>Professionelle Planung</p><div class="form-group"><label>E-Mail</label><input type="email" id="email" placeholder="deine@email.de"></div><div class="form-group"><label>Passwort</label><input type="password" id="pass" placeholder="Passwort"></div><button class="btn btn-primary" id="btnLogin">Anmelden</button><p style="margin-top:16px;font-size:13px;color:var(--text-light);">Noch kein Konto? <a href="#" id="showRegister" style="color:var(--primary);cursor:pointer;">Registrieren</a></p></div>`;
      document.getElementById("btnLogin").addEventListener("click", login);
      document.getElementById("showRegister").addEventListener("click", (e) => { e.preventDefault(); renderRegister(); });
    }

    function renderRegister() {
      elApp.innerHTML = `<div class="login-container"><h1>Registrierung</h1><p>Admin muss dich freischalten</p><div class="form-group"><label>Name</label><input type="text" id="name" placeholder="Vorname Nachname"></div><div class="form-group"><label>E-Mail</label><input type="email" id="email" placeholder="deine@email.de"></div><div class="form-group"><label>Passwort</label><input type="password" id="pass" placeholder="Mind. 8 Zeichen"></div><button class="btn btn-primary" id="btnRegister">Registrieren</button><p style="margin-top:16px;font-size:13px;color:var(--text-light);">Schon Konto? <a href="#" id="showLogin" style="color:var(--primary);cursor:pointer;">Login</a></p></div>`;
      document.getElementById("btnRegister").addEventListener("click", register);
      document.getElementById("showLogin").addEventListener("click", (e) => { e.preventDefault(); renderLogin(); });
    }

    async function login() {
      const email = document.getElementById("email").value.trim();
      const pass = document.getElementById("pass").value;
      if (!email || !pass) return toast("E-Mail und Passwort eingeben.");
      const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
      if (error) return toast("Login fehlgeschlagen: " + error.message);
      STATE.user = data.user;
      await safeRoute();
    }

    async function register() {
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const pass = document.getElementById("pass").value;
      if (!name || !email || !pass) return toast("Alle Felder ausfüllen.");
      const { data, error } = await sb.auth.signUp({ email, password: pass });
      if (error) return toast("Registrierung fehlgeschlagen: " + error.message);
      if (data.user?.id) await sb.from("profiles").update({ name }).eq("id", data.user.id).catch(() => {});
      toast("Registriert! Warte auf Admin-Freigabe.");
      renderLogin();
    }

    async function logout() {
      await sb.auth.signOut();
      STATE.user = null;
      renderLogin();
    }
    window.logout = logout;

    function renderPending() {
      elApp.innerHTML = `<div class="container"><div class="header header-user"><h1>Wartet auf Freischaltung</h1><p>${STATE.profile.email}</p></div><div class="section"><p style="color:var(--text-light)">Admin muss dich noch freischalten.</p><button class="btn btn-primary" id="btnLogout">Abmelden</button></div></div>`;
      document.getElementById("btnLogout").addEventListener("click", logout);
    }

    function techRoleLabel(p) {
      if (p?.tech_role === "ton") return "Ton";
      if (p?.tech_role === "video") return "Video";
      if (p?.tech_role === "both") return "Allrounder";
      return "Techniker";
    }

    function renderTech() {
      if (!STATE.plan) {
        elApp.innerHTML = `<div class="container"><div class="header header-user"><h1>Hallo ${STATE.profile.name || STATE.profile.email.split("@")[0]}</h1></div><div class="section"><p style="color:var(--text-light)">Es gibt noch keinen Plan.</p><button class="btn btn-primary" id="btnLogout">Abmelden</button></div></div>`;
        document.getElementById("btnLogout").addEventListener("click", logout);
        return;
      }

      const myResp = STATE.responses[STATE.user.id] || {};
      const myComm = STATE.techComments[STATE.user.id] || {};
      const isOpen = !!STATE.plan.avail_open;

      const rows = STATE.planSundays.map(date => {
        const my = myResp[date];
        const comment = myComm[date] || "";
        return `<tr>
          <td class="date-cell"><strong>${fmtDateDE(date)}</strong></td>
          <td><div class="color-row">
            <div class="color-option color-red ${my === "red" ? "selected" : ""}" data-date="${date}" data-color="red" aria-disabled="${!isOpen}"></div>
            <div class="color-option color-yellow ${my === "yellow" ? "selected" : ""}" data-date="${date}" data-color="yellow" aria-disabled="${!isOpen}"></div>
            <div class="color-option color-green ${my === "green" ? "selected" : ""}" data-date="${date}" data-color="green" aria-disabled="${!isOpen}"></div>
          </div></td>
          <td><textarea class="tech-comment" data-date="${date}" ${!isOpen ? "disabled" : ""} style="width:100%;min-height:50px;font-size:12px;">${comment}</textarea></td>
        </tr>`;
      }).join("");

      const assigned = STATE.planSundays.filter(d => (STATE.assignments[d] || []).includes(STATE.user.id));
      const approved = STATE.technicians.filter(t => t.approved);

      const assignedHtml = assigned.length ? assigned.map(d => {
        const teamIds = STATE.assignments[d] || [];
        const names = teamIds.map(id => {
          if (id === STATE.user.id) return "Du";
          const t = approved.find(x => x.id === id);
          return t ? (t.name || t.email) : "?";
        }).join(" + ");
        return `<div style="background:#e8f5e8;padding:12px;border-radius:8px;margin-bottom:10px;border-left:4px solid var(--success);">
          <strong>${fmtDateDE(d)}</strong><br><span style="color:var(--text-light);font-size:13px;">Team: ${names}</span>
        </div>`;
      }).join("") : `<p style="color:var(--text-light)">Noch keine Zuweisung</p>`;

      const adminMsg = STATE.plan?.admin_comment ? `<div class="comment-box"><strong>Admin:</strong><p>${STATE.plan.admin_comment}</p></div>` : "";

      elApp.innerHTML = `<div class="container">
        <div class="header header-user"><h1>${STATE.profile.name || "Hallo"} <span class="badge">${techRoleLabel(STATE.profile)}</span></h1></div>
        ${adminMsg}
        <div class="section">
          <h2>Verfügbarkeit ${!isOpen ? '<span style="color:var(--warning)">GESPERRT</span>' : ''}</h2>
          <div class="plan-table">
            <table>
              <tr><th>Sonntag</th><th style="text-align:center">Verfügbarkeit</th><th>Sonderwünsche</th></tr>
              ${rows}
            </table>
          </div>
          <div class="button-group">
            <button class="btn btn-success" id="btnSave" ${!isOpen ? "disabled" : ""}>Speichern</button>
            <button class="btn btn-primary" id="btnExport">Kalender exportieren</button>
          </div>
        </div>
        <div class="section">
          <h2>Deine Termine</h2>
          ${assignedHtml}
          <button class="btn btn-primary" id="btnLogout" style="margin-top:15px;">Abmelden</button>
        </div>
      </div>`;

      document.getElementById("btnLogout").addEventListener("click", logout);
      document.getElementById("btnExport").addEventListener("click", exportMyCalendar);
      if (isOpen) {
        document.getElementById("btnSave").addEventListener("click", saveTechResponses);
        elApp.querySelectorAll(".color-option").forEach(el => {
          el.addEventListener("click", () => {
            const date = el.getAttribute("data-date");
            const color = el.getAttribute("data-color");
            if (!STATE.responses[STATE.user.id]) STATE.responses[STATE.user.id] = {};
            STATE.responses[STATE.user.id][date] = color;
            renderTech();
          });
        });
        elApp.querySelectorAll(".tech-comment").forEach(el => {
          el.addEventListener("input", () => {
            const date = el.getAttribute("data-date");
            if (!STATE.techComments[STATE.user.id]) STATE.techComments[STATE.user.id] = {};
            STATE.techComments[STATE.user.id][date] = el.value;
          });
        });
      }
    }

    async function saveTechResponses() {
      if (!STATE.plan?.avail_open) return toast("Eintragen gesperrt.");
      const myResp = STATE.responses[STATE.user.id] || {};
      const myComm = STATE.techComments[STATE.user.id] || {};
      const rows = STATE.planSundays.map(d => ({ planid: STATE.plan.id, techid: STATE.user.id, sunday: d, response: myResp[d] || null, techcomment: myComm[d] || "" }));
      const { error } = await sb.from("responses").upsert(rows, { onConflict: "planid,techid,sunday" });
      if (error) return toast("Fehler: " + error.message);
      toast("Gespeichert!");
      await fetchResponsesAndAssignments();
      renderTech();
    }

    function exportMyCalendar() {
      if (!STATE.plan || !STATE.planSundays.length) return toast("Kein Plan.");
      const myDates = STATE.planSundays.filter(d => (STATE.assignments[d] || []).includes(STATE.user.id));
      if (!myDates.length) return toast("Du hast keine zugewiesenen Termine.");
      let ical = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//CGH//EN\nCALSCALE:GREGORIAN\nX-WR-CALNAME:CGH Technik\nX-WR-TIMEZONE:Europe/Berlin\nBEGIN:VTIMEZONE\nTZID:Europe/Berlin\nBEGIN:DAYLIGHT\nDTSTART:19810329T020000\nTZOFFSETFROM:+0100\nTZOFFSETTO:+0200\nRRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=-1SU\nEND:DAYLIGHT\nBEGIN:STANDARD\nDTSTART:19961027T030000\nTZOFFSETFROM:+0200\nTZOFFSETTO:+0100\nRRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU\nEND:STANDARD\nEND:VTIMEZONE\n`;
      const techs = STATE.technicians.filter(t => t.approved);
      myDates.forEach(date => {
        const ids = STATE.assignments[date] || [];
        const names = ids.map(id => { const t = techs.find(x => x.id === id); return t ? (t.name || t.email) : "?"; }).join(", ");
        const d = new Date(date + "T18:00:00Z");
        const start = d.toISOString().replace(/[-:]/g, "").slice(0, -4) + "Z";
        const end = new Date(d.getTime() + 3 * 3600000).toISOString().replace(/[-:]/g, "").slice(0, -4) + "Z";
        ical += `BEGIN:VEVENT\nUID:${STATE.plan.id}-${date}-${STATE.user.id}@cgh\nDTSTART:${start}\nDTEND:${end}\nSUMMARY:CGH - ${fmtDateDE(date)}\nDESCRIPTION:Team: ${names || "TBD"}\nEND:VEVENT\n`;
      });
      ical += `END:VCALENDAR`;
      const blob = new Blob([ical], { type: "text/calendar" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `CGH-${STATE.plan.id}.ics`;
      a.click();
      URL.revokeObjectURL(url);
      toast("Exportiert!");
    }

    async function refreshAdmin() {
      await fetchTechnicians();
      await fetchCurrentPlan(true);
      await fetchResponsesAndAssignments();
      renderAdmin();
    }

    function renderAdmin() {
      const plan = STATE.plan;
      const techs = STATE.technicians.map(t => `<div class="tech-card"><div class="tech-info"><h4>${t.name || "Kein Name"} ${t.approved ? "✅" : "⏳"}</h4><p><span class="role-badge">${techRoleLabel(t)}</span> ${t.email}</p></div><div style="display:flex;gap:8px;"><button class="btn btn-success btn-small" data-id="${t.id}" data-app="true">✓</button><button class="btn btn-danger btn-small" data-id="${t.id}" data-app="false">✕</button></div></div>`).join("");

      let planHtml = '';
      if (plan) {
        const myResp = STATE.responses[STATE.user.id] || {};
        const myComm = STATE.techComments[STATE.user.id] || {};
        const adminRows = STATE.planSundays.map(date => {
          const my = myResp[date];
          const comment = myComm[date] || "";
          return `<tr>
            <td class="date-cell"><strong>${fmtDateDE(date)}</strong></td>
            <td><div class="color-row">
              <div class="color-option color-red ${my === "red" ? "selected" : ""}" data-date="${date}" data-color="red" data-admin="true"></div>
              <div class="color-option color-yellow ${my === "yellow" ? "selected" : ""}" data-date="${date}" data-color="yellow" data-admin="true"></div>
              <div class="color-option color-green ${my === "green" ? "selected" : ""}" data-date="${date}" data-color="green" data-admin="true"></div>
            </div></td>
            <td><textarea class="admin-comment" data-date="${date}" style="width:100%;min-height:50px;font-size:12px;">${comment}</textarea></td>
          </tr>`;
        }).join("");

        const allTechs = [STATE.profile, ...STATE.technicians.filter(t => t.approved && t.id !== STATE.profile.id)];
        const tableHeader = allTechs.map(t => `<th>${t.name || t.email}</th>`).join("");
        const respRows = STATE.planSundays.map(date => { 
          const tds = allTechs.map(t => { 
            const resp = (STATE.responses[t.id] || {})[date]; 
            const emoji = resp === "green" ? "✅" : resp === "yellow" ? "❓" : resp === "red" ? "❌" : ""; 
            return `<td class="response-cell">${emoji}</td>`; 
          }).join(""); 
          return `<tr><td class="date-cell">${fmtDateDE(date)}</td>${tds}</tr>`; 
        }).join("");

        planHtml = `
        <div class="section">
          <h3>Technik-Übersicht (alle Verfügbarkeiten)</h3>
          <div class="plan-table">
            <table>
              <tr><th>Sonntag</th>${tableHeader}</tr>
              ${respRows}
            </table>
          </div>
        </div>

        <div class="section">
          <h3>Admin-Eintragung (deine Verfügbarkeit)</h3>
          <div class="plan-table">
            <table>
              <tr><th>Sonntag</th><th style="text-align:center">Verfügbarkeit</th><th>Sonderwünsche</th></tr>
              ${adminRows}
            </table>
          </div>
          <div class="button-group">
            <button class="btn btn-success" id="btnSaveAdminAvail">Admin-Eintragung speichern</button>
          </div>
        </div>

        <div class="section">
          <h3>Plan Status</h3>
          <p style="margin-bottom:10px;color:var(--text-light)">Status: <strong>${plan.status}</strong> ${plan.published ? '| LIVE' : '| DRAFT'}</p>
          <p style="margin-bottom:15px;color:var(--text-light)">Eintragung: <strong>${plan.avail_open ? 'OFFEN' : 'GESPERRT'}</strong></p>
          <div class="button-group">
            ${!plan.published ? '<button class="btn btn-success btn-small" id="btnPublish">Freigeben</button>' : ''}
            ${plan.avail_open ? '<button class="btn btn-danger btn-small" id="btnLock">Sperren</button>' : '<button class="btn btn-success btn-small" id="btnOpen">Öffnen</button>'}
            <button class="btn btn-primary btn-small" id="btnAutoAssign">Auto-Zuweisung</button>
            <button class="btn btn-primary btn-small" id="btnExportAll">Kalender Export</button>
            <button class="btn btn-danger btn-small" id="btnDeletePlan">Löschen</button>
          </div>
        </div>
        `;
      }

      elApp.innerHTML = `<div class="container">
        <div class="header header-admin"><h1>Admin Dashboard <span class="badge">ADMIN</span></h1><p>${STATE.profile.email}</p></div>
        <div class="section">
          <h3>Techniker freischalten</h3>
          <div style="max-height:300px;overflow:auto;">${techs || '<p style="color:var(--text-light)">Keine Techniker</p>'}</div>
        </div>
        <div class="section">
          <h3>Neuer Plan</h3>
          <div class="form-row"><input id="planStart" type="date"><input id="planWeeks" type="number" value="4" min="1"></div>
          <div class="form-group"><label>Admin-Kommentar</label><textarea id="adminComment" placeholder="z.B. Kaffee und Kuchen" style="min-height:80px;"></textarea></div>
          <button class="btn btn-primary" id="btnCreatePlan">Plan erstellen</button>
        </div>
        ${planHtml}
        <div class="section"><button class="btn btn-primary" id="btnLogout">Abmelden</button></div>
      </div>`;

      document.getElementById("btnLogout").addEventListener("click", logout);
      document.getElementById("btnCreatePlan").addEventListener("click", createPlan);
      elApp.querySelectorAll("[data-app]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          const app = btn.getAttribute("data-app") === "true";
          const { error } = await sb.from("profiles").update({ approved: app }).eq("id", id);
          if (error) return toast("Fehler: " + error.message);
          await refreshAdmin();
        });
      });
      if (plan) {
        document.getElementById("btnPublish")?.addEventListener("click", async () => {
          const { error } = await sb.from("plans").update({ published: true }).eq("id", plan.id);
          if (error) return toast("Fehler: " + error.message);
          await refreshAdmin();
        });
        document.getElementById("btnOpen")?.addEventListener("click", async () => {
          const { error } = await sb.from("plans").update({ avail_open: true }).eq("id", plan.id);
          if (error) return toast("Fehler: " + error.message);
          await refreshAdmin();
        });
        document.getElementById("btnLock")?.addEventListener("click", async () => {
          const { error } = await sb.from("plans").update({ avail_open: false }).eq("id", plan.id);
          if (error) return toast("Fehler: " + error.message);
          await refreshAdmin();
        });
        document.getElementById("btnSaveAdminAvail")?.addEventListener("click", saveAdminAvailability);
        document.getElementById("btnDeletePlan")?.addEventListener("click", async () => {
          if (!confirm("Wirklich löschen?")) return;
          const { error } = await sb.from("plans").delete().eq("id", plan.id);
          if (error) return toast("Fehler: " + error.message);
          await refreshAdmin();
        });
        document.getElementById("btnAutoAssign")?.addEventListener("click", autoAssign);
        document.getElementById("btnExportAll")?.addEventListener("click", exportAllCalendar);
        elApp.querySelectorAll(".color-option[data-admin='true']").forEach(el => {
          el.addEventListener("click", () => {
            const date = el.getAttribute("data-date");
            const color = el.getAttribute("data-color");
            if (!STATE.responses[STATE.user.id]) STATE.responses[STATE.user.id] = {};
            STATE.responses[STATE.user.id][date] = color;
            renderAdmin();
          });
        });
        elApp.querySelectorAll(".admin-comment").forEach(el => {
          el.addEventListener("input", () => {
            const date = el.getAttribute("data-date");
            if (!STATE.techComments[STATE.user.id]) STATE.techComments[STATE.user.id] = {};
            STATE.techComments[STATE.user.id][date] = el.value;
          });
        });
      }
    }

    async function saveAdminAvailability() {
      if (!STATE.plan) return;
      const myResp = STATE.responses[STATE.user.id] || {};
      const myComm = STATE.techComments[STATE.user.id] || {};
      const rows = STATE.planSundays.map(d => ({ planid: STATE.plan.id, techid: STATE.user.id, sunday: d, response: myResp[d] || null, techcomment: myComm[d] || "" }));
      const { error } = await sb.from("responses").upsert(rows, { onConflict: "planid,techid,sunday" });
      if (error) return toast("Fehler: " + error.message);
      toast("Admin-Eintragung gespeichert!");
      await fetchResponsesAndAssignments();
      renderAdmin();
    }

    async function createPlan() {
      const start = document.getElementById("planStart").value;
      const weeks = parseInt(document.getElementById("planWeeks").value, 10);
      const comment = document.getElementById("adminComment").value.trim();
      if (!start || !weeks) return toast("Startdatum und Wochen eingeben.");
      let d = new Date(start + "T12:00:00");
      if (d.getDay() !== 0) d.setDate(d.getDate() + (7 - d.getDay()));
      const sundays = [];
      for (let i = 0; i < weeks; i++) {
        sundays.push(d.toISOString().split("T")[0]);
        d.setDate(d.getDate() + 7);
      }
      const { data: plan, error: e1 } = await sb.from("plans").insert([{ status: "pending", created_by: STATE.user.id, admin_comment: comment, avail_open: false }]).select().single();
      if (e1) return toast("Fehler: " + e1.message);
      const rows = sundays.map(s => ({ planid: plan.id, sunday: s }));
      const { error: e2 } = await sb.from("plansundays").insert(rows);
      if (e2) return toast("Fehler: " + e2.message);
      toast("Plan erstellt!");
      await refreshAdmin();
    }

    async function autoAssign() {
      if (!STATE.plan) return;
      const techs = STATE.technicians.filter(t => t.approved);
      for (const date of STATE.planSundays) {
        const scores = {};
        techs.forEach(t => {
          const r = (STATE.responses[t.id] || {})[date];
          scores[t.id] = r === "green" ? 2 : r === "yellow" ? 1 : r === "red" ? -5 : 0;
        });
        const ton = techs.filter(t => t.tech_role === "ton" || t.tech_role === "both").sort((a, b) => scores[b.id] - scores[a.id])[0];
        const video = techs.filter(t => (t.tech_role === "video" || t.tech_role === "both") && t.id !== ton?.id).sort((a, b) => scores[b.id] - scores[a.id])[0];
        const ids = [];
        if (ton) ids.push(ton.id);
        if (video) ids.push(video.id);
        const { error } = await sb.from("assignments").upsert([{ planid: STATE.plan.id, sunday: date, techids: ids }], { onConflict: "planid,sunday" });
        if (error) return toast("Fehler: " + error.message);
      }
      toast("Zugewiesen!");
      await refreshAdmin();
    }

    function exportAllCalendar() {
      if (!STATE.plan || !STATE.planSundays.length) return toast("Kein Plan.");
      let ical = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//CGH//EN\nX-WR-CALNAME:CGH Plan\nX-WR-TIMEZONE:Europe/Berlin\nEND:VTIMEZONE\n`;
      const allTechs = [STATE.profile, ...STATE.technicians.filter(t => t.approved && t.id !== STATE.profile.id)];
      STATE.planSundays.forEach(date => {
        const ids = STATE.assignments[date] || [];
        const names = ids.map(id => { const t = allTechs.find(x => x.id === id); return t ? (t.name || t.email) : "?"; }).join(", ");
        const d = new Date(date + "T18:00:00Z");
        const start = d.toISOString().replace(/[-:]/g, "").slice(0, -4) + "Z";
        const end = new Date(d.getTime() + 3 * 3600000).toISOString().replace(/[-:]/g, "").slice(0, -4) + "Z";
        ical += `BEGIN:VEVENT\nUID:${STATE.plan.id}-${date}@cgh\nDTSTART:${start}\nDTEND:${end}\nSUMMARY:CGH - ${fmtDateDE(date)}\nDESCRIPTION:${names || "TBD"}\nEND:VEVENT\n`;
      });
      ical += `END:VCALENDAR`;
      const blob = new Blob([ical], { type: "text/calendar" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `CGH-Plan-${STATE.plan.id}.ics`;
      a.click();
      URL.revokeObjectURL(url);
      toast("Exportiert!");
    }

    async function route() {
      await safeLoadSession();
      if (!STATE.user) return renderLogin();
      await fetchMyProfile();
      if (!STATE.profile) return renderLogin();
      if (STATE.profile.role === "admin") {
        await fetchTechnicians();
        await fetchCurrentPlan(true);
        await fetchResponsesAndAssignments();
        return renderAdmin();
      }
      if (!STATE.profile.approved) return renderPending();
      await fetchTechnicians();
      await fetchCurrentPlan(false);
      await fetchResponsesAndAssignments();
      return renderTech();
    }

    async function safeRoute() {
      try { await route(); } catch (e) {
        elApp.innerHTML = `<div class="fatal"><h2 style="color:var(--error)">Fehler</h2><pre>${e?.message || e}</pre></div>`;
      }
    }

    sb.auth.onAuthStateChange(() => safeRoute());
    safeRoute();
  </script>
</body>
</html>
