<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üîß CGH Technik Planer</title>

  <!-- Supabase JS via CDN (Opera-safe, no ESM import) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary: #208085;
      --primary-dark: #1a6770;
      --admin: #c01530;
      --admin-dark: #a01229;
      --user: #22a344;
      --user-dark: #1a8637;
      --bg: #f5f5f5;
      --surface: #ffffff;
      --text: #1a1a1a;
      --text-light: #666;
      --border: #e0e0e0;
      --success: #22a344;
      --warning: #f0a500;
      --error: #c01530;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

    .login-container {
      max-width: 420px;
      margin: 80px auto;
      padding: 40px;
      background: var(--surface);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      text-align: center;
    }

    .login-container h1 {
      font-size: 32px;
      margin-bottom: 10px;
      background: linear-gradient(135deg, var(--primary), var(--admin));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .login-container p { color: var(--text-light); margin-bottom: 20px; }

    .form-group { margin-bottom: 20px; text-align: left; }
    label { display:block; font-weight:600; margin-bottom:8px; font-size:14px; }

    input, select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(32,128,133,0.1);
    }

    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(32,128,133,0.3); }

    .btn-success { background: var(--success); color: #fff; }
    .btn-success:hover { background: var(--user-dark); }

    .btn-danger { background: var(--error); color: #fff; }
    .btn-danger:hover { background: var(--admin-dark); }

    .btn-small { padding: 8px 12px; font-size: 13px; width: auto; }

    .header {
      padding: 30px 20px;
      border-radius: 12px;
      color: white;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .header-admin { background: linear-gradient(135deg, var(--admin), var(--admin-dark)); }
    .header-user  { background: linear-gradient(135deg, var(--user), var(--user-dark)); }

    .header h1 { margin: 0; font-size: 28px; }
    .header p { margin: 5px 0 0 0; opacity: 0.95; }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 10px;
      background: rgba(255,255,255,0.2);
    }

    .section {
      background: var(--surface);
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .section h2 { font-size: 20px; margin-bottom: 20px; }
    .section h3 { font-size: 16px; margin-bottom: 15px; }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    .form-row.three { grid-template-columns: 1fr 1fr 1fr; }

    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th {
      background: #f8f9fa;
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid var(--border);
      font-size: 13px;
      text-transform: uppercase;
    }
    td { padding: 12px 15px; border-bottom: 1px solid var(--border); }
    tr:hover { background: #fafafa; }

    .plan-table { overflow-x: auto; }
    .date-cell { font-weight: 600; background: #f8f9fa; }
    .response-cell { text-align: center; font-weight: 600; font-size: 18px; }

    .color-row { display:flex; gap:10px; margin:15px 0; }
    .color-option {
      width: 40px; height: 40px; border-radius: 8px; cursor: pointer;
      border: 3px solid transparent; transition: all 0.3s ease; position: relative;
    }
    .color-option:hover { transform: scale(1.1); }
    .color-option.selected::after {
      content: '‚úì'; position:absolute; top:50%; left:50%;
      transform: translate(-50%,-50%); font-size: 20px; font-weight: bold; color: white;
    }
    .color-red { background:#ffcdd2; border-color:#ef5350; }
    .color-yellow { background:#fff9c4; border-color:#fbc02d; }
    .color-green { background:#c8e6c9; border-color:#43a047; }

    .tech-card {
      background: var(--surface);
      border: 2px solid var(--border);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 12px;
      display:flex; justify-content:space-between; align-items:center;
      transition: all 0.3s ease;
    }
    .tech-card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(32,128,133,0.15); }

    .tech-info { flex: 1; }
    .tech-info h4 { margin:0 0 5px 0; font-size:16px; }
    .tech-info p { margin:3px 0; font-size:13px; color: var(--text-light); }

    .role-badge {
      display:inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 5px;
      background: var(--primary);
      color: white;
    }

    .button-group { display:flex; gap:10px; margin-top:20px; flex-wrap:wrap; }
    .button-group .btn { flex:1; min-width: 150px; }

    .tech-badge {
      display:inline-block;
      background: var(--primary);
      color:#fff;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      margin-right: 6px;
      margin-bottom: 6px;
    }
    .tech-badge .remove { cursor:pointer; margin-left:8px; font-weight:700; opacity:0.9; }
    .tech-badge .remove:hover { opacity:1; text-decoration: underline; }

    .info-box {
      background: #e3f2fd;
      border-left: 4px solid var(--primary);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .info-box p { margin:0; color:#1565c0; font-size:14px; }

    .fatal {
      max-width: 1000px;
      margin: 40px auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid var(--error);
    }
    .fatal pre { white-space: pre-wrap; background:#f7f7f7; padding:10px; border-radius:8px; overflow:auto; margin-top:10px; }

    @media (max-width: 768px) {
      .form-row { grid-template-columns: 1fr; }
      .form-row.three { grid-template-columns: 1fr; }
      .container { padding: 10px; }
      .login-container { margin: 40px auto; }
      .section { padding: 15px; }
      .tech-card { flex-direction: column; align-items:flex-start; }
      .button-group { flex-direction: column; }
      .button-group .btn { min-width: auto; }
      table { font-size: 13px; }
      th, td { padding: 8px 10px; }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://orcpugfqltiljnvlitsn.supabase.co";
    const SUPABASE_KEY = "sb_publishable_Bmkzy_E73Vjn4ySDK3cl2w_d4h1VKgl";

    // Supabase global object comes from CDN script
    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

    const elApp = document.getElementById("app");

    window.onerror = function(message, source, lineno, colno) {
      if (!elApp) return false;
      elApp.innerHTML = `
        <div class="fatal">
          <h2 style="margin:0 0 8px 0;color:var(--error)">Fehler in der App</h2>
          <p style="margin:0;color:var(--text-light)">Bitte Screenshot an Jan schicken:</p>
          <pre>${String(message)}\n${String(source)}:${lineno}:${colno}</pre>
        </div>
      `;
      return true;
    };

    const STATE = {
      user: null,
      profile: null,
      plan: null,
      planSundays: [],
      technicians: [],
      responses: {},
      assignments: {}
    };

    const fmtDateDE = (isoDate) => new Date(isoDate + "T12:00:00").toLocaleDateString("de-DE");
    const toast = (msg) => alert(msg);

    async function loadSession() {
      const { data } = await sb.auth.getSession();
      STATE.user = data.session?.user || null;
    }

    async function fetchMyProfile() {
      if (!STATE.user) return null;
      const { data, error } = await sb
        .from("profiles")
        .select("id,email,name,role,approved,tech_role,created_at")
        .eq("id", STATE.user.id)
        .maybeSingle();
      if (error) throw error;
      STATE.profile = data || null;
      return STATE.profile;
    }

    async function fetchCurrentPlan() {
      const { data, error } = await sb
        .from("plans")
        .select("id,status,created_at,created_by")
        .order("created_at", { ascending: false })
        .limit(1);
      if (error) throw error;

      STATE.plan = (data && data.length) ? data[0] : null;
      if (!STATE.plan) {
        STATE.planSundays = [];
        return null;
      }

      const { data: sundays, error: e2 } = await sb
        .from("plan_sundays")
        .select("sunday")
        .eq("plan_id", STATE.plan.id)
        .order("sunday", { ascending: true });
      if (e2) throw e2;

      STATE.planSundays = (sundays || []).map(x => x.sunday);
      return STATE.plan;
    }

    async function fetchTechnicians() {
      const { data, error } = await sb
        .from("profiles")
        .select("id,email,name,role,approved,tech_role,created_at")
        .eq("role", "tech")
        .order("created_at", { ascending: true });
      if (error) throw error;

      STATE.technicians = data || [];
      return STATE.technicians;
    }

    async function fetchResponsesAndAssignments() {
      if (!STATE.plan) {
        STATE.responses = {};
        STATE.assignments = {};
        return;
      }

      const { data: resp, error: e1 } = await sb
        .from("responses")
        .select("tech_id,sunday,response")
        .eq("plan_id", STATE.plan.id);
      if (e1) throw e1;

      const respMap = {};
      (resp || []).forEach(r => {
        if (!respMap[r.tech_id]) respMap[r.tech_id] = {};
        respMap[r.tech_id][r.sunday] = r.response;
      });
      STATE.responses = respMap;

      const { data: asg, error: e2 } = await sb
        .from("assignments")
        .select("sunday,tech_ids")
        .eq("plan_id", STATE.plan.id);
      if (e2) throw e2;

      const asgMap = {};
      (asg || []).forEach(a => { asgMap[a.sunday] = a.tech_ids || []; });
      STATE.assignments = asgMap;
    }

    function renderLogin() {
      elApp.innerHTML = `
        <div class="login-container">
          <h1>üîß CGH Technik</h1>
          <p>Professionelle Planung f√ºr dein Technik-Team</p>

          <div class="form-group">
            <label>E-Mail Adresse</label>
            <input type="email" id="email" placeholder="deine@email.de">
          </div>

          <div class="form-group">
            <label>Passwort</label>
            <input type="password" id="pass" placeholder="Dein Passwort">
          </div>

          <button class="btn btn-primary" id="btnLogin">üöÄ Anmelden</button>

          <p style="margin-top: 16px; font-size: 13px; color: var(--text-light);">
            Noch kein Konto? <a href="#" id="showRegister">Jetzt registrieren</a>
          </p>
        </div>
      `;

      document.getElementById("btnLogin").onclick = login;
      document.getElementById("showRegister").onclick = function(e) {
        e.preventDefault();
        renderRegister();
      };
    }

    function renderRegister() {
      elApp.innerHTML = `
        <div class="login-container">
          <h1>üìù Registrierung</h1>
          <p>Nach der Registrierung muss dich der Admin freischalten.</p>

          <div class="form-group">
            <label>Name</label>
            <input type="text" id="name" placeholder="Vorname Nachname">
          </div>

          <div class="form-group">
            <label>E-Mail Adresse</label>
            <input type="email" id="email" placeholder="deine@email.de">
          </div>

          <div class="form-group">
            <label>Passwort</label>
            <input type="password" id="pass" placeholder="Mind. 8 Zeichen">
          </div>

          <button class="btn btn-primary" id="btnRegister">‚úÖ Registrieren</button>

          <p style="margin-top: 16px; font-size: 13px; color: var(--text-light);">
            Schon ein Konto? <a href="#" id="showLogin">Zum Login</a>
          </p>
        </div>
      `;

      document.getElementById("btnRegister").onclick = register;
      document.getElementById("showLogin").onclick = function(e) {
        e.preventDefault();
        renderLogin();
      };
    }

    async function login() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("pass").value;
      if (!email || !password) return toast("Bitte E-Mail und Passwort eingeben.");

      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) return toast("Login fehlgeschlagen: " + error.message);

      STATE.user = data.user;
      await route();
    }

    async function register() {
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("pass").value;

      if (!name || !email || !password) return toast("Bitte Name, E-Mail und Passwort eingeben.");

      const { data, error } = await sb.auth.signUp({ email, password });
      if (error) return toast("Registrierung fehlgeschlagen: " + error.message);

      try {
        if (data.user && data.user.id) {
          await sb.from("profiles").update({ name }).eq("id", data.user.id);
        }
      } catch (e) {}

      toast("‚úÖ Registriert! Bitte warten bis der Admin dich freischaltet.");
      await loadSession();
      await route();
    }

    async function logout() {
      await sb.auth.signOut();
      STATE.user = null;
      STATE.profile = null;
      renderLogin();
    }
    window.logout = logout;

    function renderPending() {
      elApp.innerHTML = `
        <div class="container">
          <div class="header header-user">
            <h1>‚è≥ Wartet auf Freischaltung <span class="badge">TECHNIKER</span></h1>
            <p>${STATE.profile.email}</p>
          </div>

          <div class="section">
            <h2>Freischaltung erforderlich</h2>
            <p style="color: var(--text-light);">
              Dein Konto wurde angelegt, aber muss noch vom Admin freigeschaltet werden.
            </p>
            <button class="btn btn-primary" onclick="logout()">üö™ Abmelden</button>
          </div>
        </div>
      `;
    }

    function techRoleLabel(p) {
      if (p.tech_role === "ton") return "üé§ Ton Techniker";
      if (p.tech_role === "video") return "üìπ Video Techniker";
      if (p.tech_role === "both") return "üé§üìπ Allrounder";
      return "Techniker";
    }

    function renderTech() {
      const roleLabel = techRoleLabel(STATE.profile);

      if (!STATE.plan) {
        elApp.innerHTML = `
          <div class="container">
            <div class="header header-user">
              <h1>üë§ Hallo ${STATE.profile.name || STATE.profile.email.split("@")[0]} <span class="badge">TECHNIKER</span></h1>
              <p>${roleLabel}</p>
            </div>
            <div class="section">
              <p style="color:var(--text-light)">‚è≥ Admin hat noch keinen Plan erstellt.</p>
              <button class="btn btn-primary" onclick="logout()">üö™ Abmelden</button>
            </div>
          </div>
        `;
        return;
      }

      const myResponses = STATE.responses[STATE.user.id] || {};

      const rows = STATE.planSundays.map(date => {
        const my = myResponses[date] || "";
        return `
          <tr>
            <td><strong>${fmtDateDE(date)}</strong></td>
            <td>
              <div class="color-row">
                <div class="color-option color-red ${my === "red" ? "selected" : ""}" onclick="setAvailability('${date}','red')" title="Nicht verf√ºgbar"></div>
                <div class="color-option color-yellow ${my === "yellow" ? "selected" : ""}" onclick="setAvailability('${date}','yellow')" title="Eher nicht"></div>
                <div class="color-option color-green ${my === "green" ? "selected" : ""}" onclick="setAvailability('${date}','green')" title="Verf√ºgbar"></div>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      const myAssigned = STATE.planSundays.filter(d => (STATE.assignments[d] || []).includes(STATE.user.id));
      const assignedHtml = myAssigned.length
        ? myAssigned.map(d => `<div style="background:#e8f5e8;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid var(--success);">
              <strong>üìç ${fmtDateDE(d)}</strong>
            </div>`).join("")
        : `<p style="color:var(--text-light)">Noch keine Zuweisung vorhanden</p>`;

      elApp.innerHTML = `
        <div class="container">
          <div class="header header-user">
            <h1>üë§ Hallo ${STATE.profile.name || STATE.profile.email.split("@")[0]} <span class="badge">TECHNIKER</span></h1>
            <p>${roleLabel}</p>
          </div>

          <div class="info-box">
            <p>‚úÖ Du bist angemeldet als <strong>${STATE.profile.email}</strong></p>
          </div>

          <div class="section">
            <h2>üìÖ Deine Verf√ºgbarkeit</h2>
            <table>
              <tr>
                <th style="width:40%">Sonntag</th>
                <th style="width:60%;text-align:center;">Deine Verf√ºgbarkeit</th>
              </tr>
              ${rows}
            </table>
            <button class="btn btn-success" style="margin-top:20px;" onclick="saveAvailability()">üíæ Verf√ºgbarkeit speichern</button>
          </div>

          <div class="section">
            <h2>‚úÖ Deine zugewiesenen Termine</h2>
            ${assignedHtml}
          </div>

          <div class="section">
            <button class="btn btn-primary" onclick="logout()">üö™ Abmelden</button>
          </div>
        </div>
      `;
    }

    window.setAvailability = function(date, color) {
      if (!STATE.responses[STATE.user.id]) STATE.responses[STATE.user.id] = {};
      STATE.responses[STATE.user.id][date] = color;
      renderTech();
    };

    window.saveAvailability = async function() {
      if (!STATE.plan) return;
      const my = STATE.responses[STATE.user.id] || {};
      const rows = Object.entries(my).map(([sunday, response]) => ({
        plan_id: STATE.plan.id,
        tech_id: STATE.user.id,
        sunday: sunday,
        response: response
      }));

      const { error } = await sb
        .from("responses")
        .upsert(rows, { onConflict: "plan_id,tech_id,sunday" });

      if (error) return toast("Fehler: " + error.message);

      toast("‚úÖ Gespeichert!");
      await fetchResponsesAndAssignments();
      renderTech();
    };

    function renderAdminPlan() {
      const plan = STATE.plan;
      const techs = STATE.technicians.filter(t => t.approved);

      const tableHeader = techs.map(t =>
        `<th>${(t.name || t.email)} (${t.tech_role === "ton" ? "üé§" : t.tech_role === "video" ? "üìπ" : "üé§üìπ"})</th>`
      ).join("");

      const rows = STATE.planSundays.map(date => {
        const tds = techs.map(t => {
          const resp = (STATE.responses[t.id] || {})[date];
          const emoji = resp === "green" ? "üü¢" : resp === "yellow" ? "üü°" : resp === "red" ? "üî¥" : "‚ùì";
          return `<td class="response-cell">${emoji}</td>`;
        }).join("");

        return `<tr><td class="date-cell">${fmtDateDE(date)}</td>${tds}</tr>`;
      }).join("");

      const manualSundayOptions = STATE.planSundays.map(d => `<option value="${d}">${fmtDateDE(d)}</option>`).join("");
      const manualTechOptions = techs.map(t => `<option value="${t.id}">${t.name || t.email} (${t.tech_role || "?"})</option>`).join("");

      const assignmentsOverview = STATE.planSundays.map(date => {
        const ids = STATE.assignments[date] || [];
        const names = ids.map(id => {
          const t = techs.find(x => x.id === id);
          return (t ? (t.name || t.email) : "?");
        }).join(" + ");
        return `
          <div style="background:#f8f9fa;padding:10px;border-radius:8px;margin-bottom:10px;">
            <strong>${fmtDateDE(date)}</strong> ‚Üí ${names || "‚ùå Noch nicht zugewiesen"}
          </div>
        `;
      }).join("");

      return `
        <div class="section">
          <h3>üìä Aktueller Plan - Status: <strong>${plan.status}</strong></h3>
          <p style="color:var(--text-light);font-size:13px;margin-bottom:15px;">
            Erstellt: ${new Date(plan.created_at).toLocaleDateString("de-DE")} | ${STATE.planSundays.length} Sonntage
          </p>

          <div class="plan-table">
            <table>
              <tr>
                <th>Sonntag</th>
                ${tableHeader}
              </tr>
              ${rows}
            </table>
          </div>

          <div class="button-group">
            <button class="btn btn-success btn-small" onclick="autoAssign()">ü§ñ Auto-Zuweisung</button>
            <button class="btn btn-danger btn-small" onclick="deletePlan()">üóëÔ∏è Plan l√∂schen</button>
            <button class="btn btn-primary btn-small" onclick="refreshAdmin()">üîÑ Aktualisieren</button>
          </div>
        </div>

        <div class="section">
          <h3>üîß Manuelle Anpassung</h3>
          <div class="form-row three">
            <select id="manualDate" onchange="updateManualList()">
              <option value="">-- Sonntag w√§hlen --</option>
              ${manualSundayOptions}
            </select>
            <select id="manualTech">
              <option value="">-- Techniker w√§hlen --</option>
              ${manualTechOptions}
            </select>
            <button class="btn btn-success btn-small" style="width:100%" onclick="manualAdd()">‚ûï Hinzuf√ºgen</button>
          </div>
          <div id="manualList"></div>
        </div>

        <div class="section">
          <h3>‚úÖ Zuweisungen √úbersicht</h3>
          ${assignmentsOverview}
        </div>
      `;
    }

    function renderAdmin() {
      const plan = STATE.plan;

      const techCards = STATE.technicians.map(t => `
        <div class="tech-card">
          <div class="tech-info">
            <h4>${t.name || "(kein Name)"} ${t.approved ? "‚úÖ" : "‚è≥"}</h4>
            <p>
              <span class="role-badge">${t.tech_role === "ton" ? "üé§ Ton" : t.tech_role === "video" ? "üìπ Video" : t.tech_role === "both" ? "üé§üìπ Beides" : "‚ùì Rolle"}</span>
              ${t.email}
            </p>
            <p style="font-size:12px;margin-top:6px;color:var(--text-light);">
              Status: ${t.approved ? "Freigeschaltet" : "Wartet auf Freigabe"}
            </p>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
            <button class="btn btn-success btn-small" onclick="approveUser('${t.id}', true)">Freigeben</button>
            <button class="btn btn-danger btn-small" onclick="approveUser('${t.id}', false)">Sperren</button>
          </div>
        </div>
      `).join("");

      elApp.innerHTML = `
        <div class="container">
          <div class="header header-admin">
            <h1>‚öôÔ∏è Admin Dashboard <span class="badge">ADMIN</span></h1>
            <p>${STATE.profile.email}</p>
          </div>

          <div class="info-box">
            <p>‚úÖ Angemeldet als <strong>${STATE.profile.email}</strong> (Admin)</p>
          </div>

          <div class="section">
            <h3>üë• Freischaltung & Rollen</h3>

            <div class="form-row three">
              <select id="selTech">
                <option value="">-- Techniker w√§hlen --</option>
                ${STATE.technicians.map(t => `<option value="${t.id}">${t.email}</option>`).join("")}
              </select>
              <input id="inpName" type="text" placeholder="Name setzen (optional)">
              <select id="selTechRole">
                <option value="">-- Technik Rolle --</option>
                <option value="ton">üé§ Ton</option>
                <option value="video">üìπ Video</option>
                <option value="both">üé§üìπ Beides</option>
              </select>
            </div>
            <div class="button-group">
              <button class="btn btn-primary btn-small" onclick="saveTechMeta()">üíæ Name/Rolle speichern</button>
              <button class="btn btn-primary btn-small" onclick="refreshAdmin()">üîÑ Aktualisieren</button>
            </div>

            <div style="margin-top:18px;max-height:360px;overflow:auto;">
              ${techCards || '<p style="color:var(--text-light)">Noch keine Techniker registriert.</p>'}
            </div>
          </div>

          <div class="section">
            <h3>üÜï Neuen Plan erstellen</h3>
            <div class="form-row">
              <input id="planStart" type="date">
              <input id="planWeeks" type="number" value="4" min="1" max="12">
            </div>
            <button class="btn btn-primary" onclick="createPlan()">üìÖ Plan erstellen</button>
          </div>

          ${plan ? renderAdminPlan() : `
            <div class="section">
              <h3>üìÖ Kein Plan vorhanden</h3>
              <p style="color:var(--text-light)">Erstelle unten einen neuen Plan.</p>
            </div>
          `}

          <div class="section">
            <button class="btn btn-primary" onclick="logout()">üö™ Abmelden</button>
          </div>
        </div>
      `;

      if (plan) updateManualList();
    }

    window.refreshAdmin = async function() {
      await fetchTechnicians();
      await fetchCurrentPlan();
      await fetchResponsesAndAssignments();
      renderAdmin();
    };

    window.approveUser = async function(id, approved) {
      const { error } = await sb.from("profiles").update({ approved: approved }).eq("id", id);
      if (error) return toast("Fehler: " + error.message);
      await refreshAdmin();
    };

    window.saveTechMeta = async function() {
      const id = document.getElementById("selTech").value;
      const name = document.getElementById("inpName").value.trim();
      const tech_role = document.getElementById("selTechRole").value;

      if (!id) return toast("Bitte Techniker w√§hlen.");

      const payload = {};
      if (name) payload.name = name;
      if (tech_role) payload.tech_role = tech_role;

      if (Object.keys(payload).length === 0) return toast("Nichts zu speichern.");

      const { error } = await sb.from("profiles").update(payload).eq("id", id);
      if (error) return toast("Fehler: " + error.message);

      await refreshAdmin();
      toast("‚úÖ Gespeichert.");
    };

    window.createPlan = async function() {
      const startStr = document.getElementById("planStart").value;
      const weeks = parseInt(document.getElementById("planWeeks").value, 10);

      if (!startStr || isNaN(weeks) || weeks < 1) return toast("Startdatum + Wochen eingeben.");

      let current = new Date(startStr + "T12:00:00");
      let day = current.getDay();
      if (day !== 0) current.setDate(current.getDate() + (7 - day));

      const sundays = [];
      for (let i = 0; i < weeks; i++) {
        const y = current.getFullYear();
        const m = String(current.getMonth() + 1).padStart(2, "0");
        const d = String(current.getDate()).padStart(2, "0");
        sundays.push(`${y}-${m}-${d}`);
        current.setDate(current.getDate() + 7);
      }

      const { data: plan, error: e1 } = await sb
        .from("plans")
        .insert([{ status: "responses_pending", created_by: STATE.user.id }])
        .select("id,status,created_at,created_by")
        .single();
      if (e1) return toast("Plan Fehler: " + e1.message);

      const rows = sundays.map(s => ({ plan_id: plan.id, sunday: s }));
      const { error: e2 } = await sb.from("plan_sundays").insert(rows);
      if (e2) return toast("Sonntage Fehler: " + e2.message);

      toast("‚úÖ Plan erstellt.");
      await refreshAdmin();
    };

    window.deletePlan = async function() {
      if (!STATE.plan) return;
      if (!confirm("Plan wirklich l√∂schen?")) return;

      const { error } = await sb.from("plans").delete().eq("id", STATE.plan.id);
      if (error) return toast("Fehler: " + error.message);

      toast("‚úÖ Plan gel√∂scht.");
      await refreshAdmin();
    };

    window.updateManualList = function() {
      const date = document.getElementById("manualDate") ? document.getElementById("manualDate").value : "";
      const box = document.getElementById("manualList");
      if (!box) return;

      if (!date) {
        box.innerHTML = '<p style="color: var(--text-light); margin-top: 10px;">Bitte zuerst einen Sonntag ausw√§hlen.</p>';
        return;
      }

      const ids = STATE.assignments[date] || [];
      const techs = STATE.technicians.filter(t => t.approved);

      if (ids.length === 0) {
        box.innerHTML = '<p style="color: var(--text-light); margin-top: 10px;">Noch niemand zugewiesen.</p>';
        return;
      }

      box.innerHTML = `
        <div style="margin-top: 10px;">
          ${ids.map(id => {
            const t = techs.find(x => x.id === id);
            if (!t) return "";
            return '<span class="tech-badge">' + (t.name || t.email) +
              '<span class="remove" onclick="manualRemove(\\'' + date + '\\',\\'' + id + '\\')">‚úï</span></span>';
          }).join("")}
        </div>
      `;
    };

    window.manualAdd = async function() {
      const date = document.getElementById("manualDate") ? document.getElementById("manualDate").value : "";
      const techId = document.getElementById("manualTech") ? document.getElementById("manualTech").value : "";
      if (!STATE.plan) return;

      if (!date || !techId) return toast("Sonntag und Techniker w√§hlen.");

      const existing = STATE.assignments[date] || [];
      if (existing.includes(techId)) return toast("Techniker ist schon zugewiesen.");

      const newIds = existing.concat([techId]);

      const { error } = await sb
        .from("assignments")
        .upsert([{ plan_id: STATE.plan.id, sunday: date, tech_ids: newIds }], { onConflict: "plan_id,sunday" });

      if (error) return toast("Fehler: " + error.message);

      await fetchResponsesAndAssignments();
      renderAdmin();
    };

    window.manualRemove = async function(date, techId) {
      if (!STATE.plan) return;

      const existing = STATE.assignments[date] || [];
      const newIds = existing.filter(x => x !== techId);

      if (newIds.length === 0) {
        const { error } = await sb
          .from("assignments")
          .delete()
          .eq("plan_id", STATE.plan.id)
          .eq("sunday", date);
        if (error) return toast("Fehler: " + error.message);
      } else {
        const { error } = await sb
          .from("assignments")
          .upsert([{ plan_id: STATE.plan.id, sunday: date, tech_ids: newIds }], { onConflict: "plan_id,sunday" });
        if (error) return toast("Fehler: " + error.message);
      }

      await fetchResponsesAndAssignments();
      renderAdmin();
    };

    window.autoAssign = async function() {
      if (!STATE.plan) return;

      const techs = STATE.technicians.filter(t => t.approved);

      for (let i = 0; i < STATE.planSundays.length; i++) {
        const date = STATE.planSundays[i];

        const tons = techs.filter(t => {
          const r = (STATE.responses[t.id] || {})[date];
          return (r === "green" || r === "yellow") && (t.tech_role === "ton" || t.tech_role === "both");
        });

        const videos = techs.filter(t => {
          const r = (STATE.responses[t.id] || {})[date];
          return (r === "green" || r === "yellow") && (t.tech_role === "video" || t.tech_role === "both");
        });

        const team = [];
        if (tons.length) team.push(tons[0].id);
        if (videos.length && team.indexOf(videos[0].id) === -1) team.push(videos[0].id);

        if (team.length) {
          const { error } = await sb
            .from("assignments")
            .upsert([{ plan_id: STATE.plan.id, sunday: date, tech_ids: team }], { onConflict: "plan_id,sunday" });
          if (error) return toast("Fehler Auto-Zuweisung: " + error.message);
        }
      }

      toast("‚úÖ Auto-Zuweisung fertig.");
      await fetchResponsesAndAssignments();
      renderAdmin();
    };

    async function route() {
      await loadSession();
      if (!STATE.user) return renderLogin();

      await fetchMyProfile();

      if (!STATE.profile) {
        elApp.innerHTML = `
          <div class="container">
            <div class="fatal">
              <h2 style="margin:0 0 8px 0;color:var(--error)">Profil fehlt</h2>
              <p style="margin:0;color:var(--text-light)">
                Dein User existiert, aber es gibt keinen Eintrag in <code>profiles</code>.
                Pr√ºfe Trigger <code>handle_new_user()</code>.
              </p>
              <div style="margin-top: 12px;">
                <button class="btn btn-primary" onclick="logout()">üö™ Abmelden</button>
              </div>
            </div>
          </div>
        `;
        return;
      }

      if (STATE.profile.role === "admin") {
        await fetchTechnicians();
        await fetchCurrentPlan();
        await fetchResponsesAndAssignments();
        return renderAdmin();
      }

      if (!STATE.profile.approved) return renderPending();

      await fetchCurrentPlan();
      await fetchResponsesAndAssignments();
      return renderTech();
    }

    // Start & session change
    route();
    sb.auth.onAuthStateChange(function() { route(); });
  </script>
</body>
</html>
