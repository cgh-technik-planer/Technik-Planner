<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CGH Technik Planer</title>

  <!-- Supabase JS via CDN (no ESM import) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #208085;
      --primary-dark: #1a6770;
      --admin: #c01530;
      --admin-dark: #a01229;
      --user: #22a344;
      --user-dark: #1a8637;
      --bg: #f5f5f5;
      --surface: #ffffff;
      --text: #1a1a1a;
      --text-light: #666;
      --border: #e0e0e0;
      --success: #22a344;
      --warning: #f0a500;
      --error: #c01530;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .login-container {
      max-width: 420px; margin: 80px auto; padding: 40px;
      background: var(--surface); border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1); text-align: center;
    }
    .login-container h1 {
      font-size: 32px; margin-bottom: 10px;
      background: linear-gradient(135deg, var(--primary), var(--admin));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .login-container p { color: var(--text-light); margin-bottom: 20px; }
    .form-group { margin-bottom: 20px; text-align: left; }
    label { display:block; font-weight:600; margin-bottom:8px; font-size:14px; }
    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      font-family: inherit;
      transition: all 0.3s ease;
    }
    textarea { resize: vertical; min-height: 80px; }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(32,128,133,0.1);
    }
    input:disabled, textarea:disabled {
      background: #f0f0f0;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(32,128,133,0.3);
    }
    .btn-success { background: var(--success); color: #fff; }
    .btn-success:hover { background: var(--user-dark); }
    .btn-danger { background: var(--error); color: #fff; }
    .btn-danger:hover { background: var(--admin-dark); }
    .btn-small { padding: 8px 12px; font-size: 13px; width: auto; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .header {
      padding: 30px 20px;
      border-radius: 12px;
      color: white;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .header-admin { background: linear-gradient(135deg, var(--admin), var(--admin-dark)); }
    .header-user { background: linear-gradient(135deg, var(--user), var(--user-dark)); }
    .header h1 { margin: 0; font-size: 28px; }
    .header p { margin: 5px 0 0 0; opacity: 0.95; }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 10px;
      background: rgba(255,255,255,0.2);
    }

    .section {
      background: var(--surface);
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .section h2 { font-size: 20px; margin-bottom: 20px; }
    .section h3 { font-size: 16px; margin-bottom: 15px; }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    .form-row.three { grid-template-columns: 1fr 1fr 1fr; }

    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th {
      background: #f8f9fa;
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid var(--border);
      font-size: 13px;
      text-transform: uppercase;
    }
    td { padding: 12px 15px; border-bottom: 1px solid var(--border); }
    tr:hover { background: #fafafa; }

    .plan-table { overflow-x: auto; }
    .date-cell { font-weight: 600; background: #f8f9fa; }
    .response-cell { text-align: center; font-weight: 600; font-size: 18px; }

    /* Checkbox (falls noch irgendwo genutzt) */
    .checkbox-row { display:flex; gap:10px; margin:15px 0; align-items:center; }
    .checkbox-option { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .checkbox-option input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: #000; }
    .checkbox-option label { margin: 0; font-weight: 500; cursor: pointer; }

    .tech-card {
      background: var(--surface);
      border: 2px solid var(--border);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      transition: all 0.3s ease;
    }
    .tech-card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(32,128,133,0.15); }
    .tech-info { flex: 1; }
    .tech-info h4 { margin:0 0 5px 0; font-size:16px; }
    .tech-info p { margin:3px 0; font-size:13px; color: var(--text-light); }

    .role-badge {
      display:inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 5px;
      background: var(--primary);
      color: white;
    }

    .button-group { display:flex; gap:10px; margin-top:20px; flex-wrap:wrap; }
    .button-group .btn { flex:1; min-width: 150px; }

    .tech-badge {
      display:inline-flex;
      align-items:center;
      gap:10px;
      background: var(--primary);
      color:#fff;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      margin-right: 6px;
      margin-bottom: 6px;
    }
    .tech-badge .remove {
      cursor:pointer;
      font-weight:700;
      opacity:0.95;
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: 6px;
      user-select: none;
    }
    .tech-badge .remove:hover { opacity:1; }

    .info-box {
      background: #e3f2fd;
      border-left: 4px solid var(--primary);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .info-box p { margin:0; color:#1565c0; font-size:14px; }

    .comment-box {
      background: #f9f9f9;
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid var(--primary);
    }
    .comment-box strong { display: block; margin-bottom: 8px; color: var(--primary); }
    .comment-box p { margin: 0; font-size: 13px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }

    .fatal {
      max-width: 1000px;
      margin: 40px auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid var(--error);
    }
    .fatal pre {
      white-space: pre-wrap;
      background:#f7f7f7;
      padding:10px;
      border-radius:8px;
      overflow:auto;
      margin-top:10px;
    }

    @media (max-width: 768px) {
      .form-row { grid-template-columns: 1fr; }
      .form-row.three { grid-template-columns: 1fr; }
      .container { padding: 10px; }
      .login-container { margin: 40px auto; }
      .section { padding: 15px; }
      .tech-card { flex-direction: column; align-items:flex-start; }
      .button-group { flex-direction: column; }
      .button-group .btn { min-width: auto; }
      table { font-size: 13px; }
      th, td { padding: 8px 10px; }
    }
  </style>
</head>

<body>
  <div id="app"></div>

  <script>
    // ========= SUPABASE CONFIG =========
    const SUPABASEURL = "https://orcpugfqltiljnvlitsn.supabase.co";
    const SUPABASEKEY = "sb_publishable_Bmkzy_E73Vjn4ySDK3cl2w_d4h1VKgl";

    const { createClient } = supabase;
    const sb = createClient(SUPABASEURL, SUPABASEKEY);

    const elApp = document.getElementById("app");

    window.onerror = function(message, source, lineno, colno) {
      if (!elApp) return false;
      elApp.innerHTML = `
        <div class="fatal">
          <h2 style="margin:0 0 8px 0;color:var(--error)">Fehler in der App</h2>
          <p style="margin:0;color:var(--text-light)">Bitte Screenshot an Jan schicken</p>
          <pre>${String(message)}\n${String(source)}:${lineno}:${colno}</pre>
        </div>
      `;
      return true;
    };

    window.addEventListener("unhandledrejection", (event) => {
      const msg = event?.reason?.message ? event.reason.message : String(event.reason || "Unbekannter Promise-Fehler");
      if (elApp) {
        elApp.innerHTML = `
          <div class="fatal">
            <h2 style="margin:0 0 8px 0;color:var(--error)">Fehler Promise</h2>
            <p style="margin:0;color:var(--text-light)">Bitte Screenshot an Jan schicken</p>
            <pre>${msg}</pre>
          </div>
        `;
      }
      event.preventDefault();
    });

    const STATE = {
      user: null,
      profile: null,
      plan: null,
      planSundays: [],
      technicians: [],
      responses: {},
      assignments: {},
      techComments: {}
    };

    const fmtDateDE = (isoDate) => new Date(isoDate + "T12:00:00").toLocaleDateString("de-DE");
    const toast = (msg) => alert(msg);

    async function safeLoadSession() {
      try {
        const { data, error } = await sb.auth.getSession();
        if (error) throw error;
        STATE.user = data.session?.user || null;
      } catch (e) {
        await sb.auth.signOut();
        STATE.user = null;
      }
    }

    async function fetchMyProfile() {
      if (!STATE.user) return null;
      const { data, error } = await sb
        .from("profiles")
        .select("id,email,name,role,approved,techrole,createdat")
        .eq("id", STATE.user.id)
        .maybeSingle();
      if (error) throw error;
      STATE.profile = data || null;
      return STATE.profile;
    }

    async function fetchCurrentPlan(isAdmin) {
      let q = sb
        .from("plans")
        .select("id,status,createdat,createdby,published,admincomment")
        .order("createdat", { ascending: false })
        .limit(1);
      if (!isAdmin) q = q.eq("published", true);

      const { data, error } = await q;
      if (error) throw error;

      STATE.plan = (data && data.length) ? data[0] : null;
      if (!STATE.plan) {
        STATE.planSundays = [];
        return null;
      }

      const { data: sundays, error: e2 } = await sb
        .from("plansundays")
        .select("sunday")
        .eq("planid", STATE.plan.id)
        .order("sunday", { ascending: true });
      if (e2) throw e2;

      STATE.planSundays = (sundays || []).map(x => x.sunday);
      return STATE.plan;
    }

    async function fetchTechnicians() {
      const { data, error } = await sb
        .from("profiles")
        .select("id,email,name,role,approved,techrole,createdat")
        .eq("role", "tech")
        .order("createdat", { ascending: true });
      if (error) throw error;
      STATE.technicians = data || [];
      return STATE.technicians;
    }

    async function fetchResponsesAndAssignments() {
      if (!STATE.plan) {
        STATE.responses = {};
        STATE.assignments = {};
        STATE.techComments = {};
        return;
      }

      const { data: resp, error: e1 } = await sb
        .from("responses")
        .select("techid,sunday,response,techcomment")
        .eq("planid", STATE.plan.id);
      if (e1) throw e1;

      const respMap = {};
      const commMap = {};
      (resp || []).forEach(r => {
        if (!respMap[r.techid]) respMap[r.techid] = {};
        if (!commMap[r.techid]) commMap[r.techid] = {};
        respMap[r.techid][r.sunday] = r.response;
        commMap[r.techid][r.sunday] = r.techcomment || "";
      });
      STATE.responses = respMap;
      STATE.techComments = commMap;

      const { data: asg, error: e2 } = await sb
        .from("assignments")
        .select("sunday,techids")
        .eq("planid", STATE.plan.id);
      if (e2) throw e2;

      const asgMap = {};
      (asg || []).forEach(a => { asgMap[a.sunday] = a.techids || []; });
      STATE.assignments = asgMap;
    }

    function renderLogin() {
      elApp.innerHTML = `
        <div class="login-container">
          <h1>CGH Technik</h1>
          <p>Professionelle Planung für dein Technik-Team</p>

          <div class="form-group">
            <label>E-Mail Adresse</label>
            <input type="email" id="email" placeholder="deine@email.de">
          </div>

          <div class="form-group">
            <label>Passwort</label>
            <input type="password" id="pass" placeholder="Dein Passwort">
          </div>

          <button class="btn btn-primary" id="btnLogin">Anmelden</button>

          <p style="margin-top: 16px; font-size: 13px; color: var(--text-light);">
            Noch kein Konto? <a href="#" id="showRegister">Jetzt registrieren</a>
          </p>
        </div>
      `;

      document.getElementById("btnLogin").addEventListener("click", login);
      document.getElementById("showRegister").addEventListener("click", (e) => {
        e.preventDefault();
        renderRegister();
      });
    }

    function renderRegister() {
      elApp.innerHTML = `
        <div class="login-container">
          <h1>Registrierung</h1>
          <p>Nach der Registrierung muss dich der Admin freischalten.</p>

          <div class="form-group">
            <label>Name</label>
            <input type="text" id="name" placeholder="Vorname Nachname">
          </div>

          <div class="form-group">
            <label>E-Mail Adresse</label>
            <input type="email" id="email" placeholder="deine@email.de">
          </div>

          <div class="form-group">
            <label>Passwort</label>
            <input type="password" id="pass" placeholder="Mind. 8 Zeichen">
          </div>

          <button class="btn btn-primary" id="btnRegister">Registrieren</button>

          <p style="margin-top: 16px; font-size: 13px; color: var(--text-light);">
            Schon ein Konto? <a href="#" id="showLogin">Zum Login</a>
          </p>
        </div>
      `;

      document.getElementById("btnRegister").addEventListener("click", register);
      document.getElementById("showLogin").addEventListener("click", (e) => {
        e.preventDefault();
        renderLogin();
      });
    }

    async function login() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("pass").value;
      if (!email || !password) return toast("Bitte E-Mail und Passwort eingeben.");

      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) return toast("Login fehlgeschlagen: " + error.message);

      STATE.user = data.user;
      await safeRoute();
    }

    async function register() {
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("pass").value;

      if (!name || !email || !password) return toast("Bitte Name, E-Mail und Passwort eingeben.");

      const { data, error } = await sb.auth.signUp({ email, password });
      if (error) return toast("Registrierung fehlgeschlagen: " + error.message);

      try {
        if (data.user && data.user.id) await sb.from("profiles").update({ name }).eq("id", data.user.id);
      } catch (_) {}

      toast("Registriert! Bitte warten bis der Admin dich freischaltet.");
      await safeLoadSession();
      await safeRoute();
    }

    async function logout() {
      await sb.auth.signOut();
      STATE.user = null;
      STATE.profile = null;
      renderLogin();
    }
    window.logout = logout;

    function renderPending() {
      elApp.innerHTML = `
        <div class="container">
          <div class="header header-user">
            <h1>Wartet auf Freischaltung <span class="badge">TECHNIKER</span></h1>
            <p>${STATE.profile.email}</p>
          </div>

          <div class="section">
            <h2>Freischaltung erforderlich</h2>
            <p style="color: var(--text-light);">
              Dein Konto wurde angelegt, aber muss noch vom Admin freigeschaltet werden.
            </p>
            <button class="btn btn-primary" id="btnLogout">Abmelden</button>
          </div>
        </div>
      `;
      document.getElementById("btnLogout").addEventListener("click", logout);
    }

    function techRoleLabel(p) {
      if (p.techrole === "ton") return "Ton Techniker";
      if (p.techrole === "video") return "Video Techniker";
      if (p.techrole === "both") return "Allrounder";
      return "Techniker";
    }

    function renderTech() {
      const roleLabel = techRoleLabel(STATE.profile);
      const planPublished = STATE.plan?.published || false;

      if (!STATE.plan) {
        elApp.innerHTML = `
          <div class="container">
            <div class="header header-user">
              <h1>Hallo ${STATE.profile.name || STATE.profile.email.split("@")[0]} <span class="badge">TECHNIKER</span></h1>
              <p>${roleLabel}</p>
            </div>
            <div class="section">
              <p style="color:var(--text-light)">Es gibt noch keinen freigegebenen Plan.</p>
              <button class="btn btn-primary" id="btnLogout">Abmelden</button>
            </div>
          </div>
        `;
        document.getElementById("btnLogout").addEventListener("click", logout);
        return;
      }

      const myResponses = STATE.responses[STATE.user.id] || {};
      const myComments = STATE.techComments[STATE.user.id] || {};

      const rows = STATE.planSundays.map(date => {
        const my = myResponses[date];
        const myComment = myComments[date];
        const isDisabled = planPublished;

        return `
          <tr>
            <td><strong>${fmtDateDE(date)}</strong></td>
            <td>
              <div class="checkbox-row">
                <div class="checkbox-option">
                  <input type="checkbox" id="ck_${date}" ${my === "available" ? "checked" : ""} ${isDisabled ? "disabled" : ""} data-date="${date}" data-value="available">
                  <label for="ck_${date}">Verfügbar</label>
                </div>
              </div>
            </td>
            <td>
              <textarea ${isDisabled ? "disabled" : ""} data-date="${date}" class="tech-comment" placeholder="z.B. nur 3x, etc..." style="width: 100%; min-height: 60px; font-size: 12px;">${myComment || ""}</textarea>
            </td>
          </tr>
        `;
      }).join("");

      const approvedTechs = STATE.technicians.filter(t => t.approved);

      const myAssigned = STATE.planSundays.filter(d => (STATE.assignments[d] || []).includes(STATE.user.id));
      const assignedHtml = myAssigned.length
        ? myAssigned.map(d => {
            const teamIds = STATE.assignments[d] || [];
            const teamNames = teamIds.map(id => {
              if (id === STATE.user.id) return "Du";
              const t = approvedTechs.find(x => x.id === id);
              return t ? (t.name || t.email) : "Unbekannt";
            });

            return `
              <div style="background:#e8f5e8;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid var(--success);">
                <strong>${fmtDateDE(d)}</strong><br>
                <span style="color:var(--text-light);font-size:13px;">Team: ${teamNames.join(" + ")}</span>
              </div>
            `;
          }).join("")
        : `<p style="color:var(--text-light)">Noch keine Zuweisung vorhanden</p>`;

      const adminCommentHtml = STATE.plan?.admincomment
        ? `<div class="comment-box"><strong>Admin-Info:</strong><p>${STATE.plan.admincomment}</p></div>`
        : "";

      elApp.innerHTML = `
        <div class="container">
          <div class="header header-user">
            <h1>Hallo ${STATE.profile.name || STATE.profile.email.split("@")[0]} <span class="badge">TECHNIKER</span></h1>
            <p>${roleLabel}</p>
          </div>

          <div class="info-box">
            <p>Du bist angemeldet als <strong>${STATE.profile.email}</strong></p>
          </div>

          ${adminCommentHtml}

          <div class="section">
            <h2>Deine Verfügbarkeit ${planPublished ? '<span style="color: var(--warning);">Gesperrt</span>' : ''}</h2>
            <table>
              <tr>
                <th style="width:20%">Sonntag</th>
                <th style="width:20%">Verfügbar</th>
                <th>Sonderwünsche (nur Admin sieht das)</th>
              </tr>
              ${rows}
            </table>

            <div class="button-group" style="margin-top:20px;">
              <button class="btn btn-success" id="btnSaveAvail" ${planPublished ? "disabled" : ""}>Verfügbarkeit speichern</button>
              <button class="btn btn-primary" id="btnMyCalendarExport">Meine Termine exportieren (.ics)</button>
            </div>
          </div>

          <div class="section">
            <h2>Deine zugewiesenen Termine</h2>
            ${assignedHtml}
          </div>

          <div class="section">
            <button class="btn btn-primary" id="btnLogout">Abmelden</button>
          </div>
        </div>
      `;

      document.getElementById("btnLogout").addEventListener("click", logout);
      document.getElementById("btnMyCalendarExport").addEventListener("click", exportMyCalendar);

      if (!planPublished) {
        document.getElementById("btnSaveAvail").addEventListener("click", saveAvailability);

        elApp.querySelectorAll(".tech-comment").forEach(el => {
          el.addEventListener("change", () => {
            const date = el.getAttribute("data-date");
            const comment = el.value;
            if (!STATE.techComments[STATE.user.id]) STATE.techComments[STATE.user.id] = {};
            STATE.techComments[STATE.user.id][date] = comment;
          });
        });

        elApp.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.addEventListener("change", () => {
            const date = cb.getAttribute("data-date");
            if (cb.checked) {
              if (!STATE.responses[STATE.user.id]) STATE.responses[STATE.user.id] = {};
              STATE.responses[STATE.user.id][date] = "available";
            } else {
              if (!STATE.responses[STATE.user.id]) STATE.responses[STATE.user.id] = {};
              STATE.responses[STATE.user.id][date] = "";
            }
          });
        });
      }
    }

    async function saveAvailability() {
      if (!STATE.plan) return;

      const my = STATE.responses[STATE.user.id] || {};
      const myComments = STATE.techComments[STATE.user.id] || {};

      const rows = Object.entries(my).map(([sunday, response]) => ({
        planid: STATE.plan.id,
        techid: STATE.user.id,
        sunday,
        response: response === "available" ? "green" : "red",
        techcomment: myComments[sunday] || ""
      }));

      const { error } = await sb
        .from("responses")
        .upsert(rows, { onConflict: "planid,techid,sunday" });

      if (error) return toast("Fehler: " + error.message);

      toast("Gespeichert!");
      await fetchResponsesAndAssignments();
      renderTech();
    }

    // NEU: Techniker exportiert nur eigene Termine
    function exportMyCalendar() {
      if (!STATE.plan || !STATE.planSundays.length) return toast("Kein Plan vorhanden.");

      const myDates = STATE.planSundays.filter(d => (STATE.assignments[d] || []).includes(STATE.user.id));
      if (myDates.length === 0) return toast("Du hast aktuell keine zugewiesenen Termine im Plan.");

      let ical = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//CGH Technik Planer//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:CGH Technik - Meine Termine
X-WR-TIMEZONE:Europe/Berlin
BEGIN:VTIMEZONE
TZID:Europe/Berlin
BEGIN:STANDARD
DTSTART:19961027T030000
TZOFFSETFROM:+0200
TZOFFSETTO:+0100
RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU
END:STANDARD
BEGIN:DAYLIGHT
DTSTART:19810329T020000
TZOFFSETFROM:+0100
TZOFFSETTO:+0200
RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=-1SU
END:DAYLIGHT
END:VTIMEZONE
`;

      const techs = STATE.technicians.filter(t => t.approved);

      myDates.forEach(date => {
        const ids = STATE.assignments[date] || [];
        const names = ids.map(id => {
          const t = techs.find(x => x.id === id);
          return t ? (t.name || t.email) : "?";
        }).join(", ");

        const d = new Date(date + "T18:00:00");
        const dtstart = d.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";
        const dtend = new Date(d.getTime() + 3 * 60 * 60000).toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";

        ical += `BEGIN:VEVENT
UID:${STATE.plan.id}-${date}-${STATE.user.id}@cgh-technik
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, "").split(".")[0]}Z
DTSTART:${dtstart}
DTEND:${dtend}
SUMMARY:CGH Technik - ${fmtDateDE(date)}
DESCRIPTION:Team: ${names || "noch nicht zugewiesen"}
LOCATION:CGH Stuttgart
STATUS:CONFIRMED
SEQUENCE:0
END:VEVENT
`;
      });

      ical += `END:VCALENDAR`;

      const blob = new Blob([ical], { type: "text/calendar;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `CGH-Technik-Meine-Termine-${STATE.plan.id}.ics`;
      link.click();
      URL.revokeObjectURL(url);

      toast("Deine Termine wurden exportiert!");
    }

    async function publishPlan() {
      if (!STATE.plan) return;
      const { error } = await sb
        .from("plans")
        .update({ published: true })
        .eq("id", STATE.plan.id);
      if (error) return toast("Fehler: " + error.message);
      toast("Plan freigegeben. Techniker können nicht mehr ändern!");
      await refreshAdmin();
    }

    function renderAdmin() {
      const plan = STATE.plan;

      const techCards = STATE.technicians.map(t => `
        <div class="tech-card">
          <div class="tech-info">
            <h4>${t.name || "kein Name"} ${t.approved ? "✅" : "⏳"}</h4>
            <p>
              <span class="role-badge">${
                t.techrole === "ton" ? "Ton" :
                t.techrole === "video" ? "Video" :
                t.techrole === "both" ? "Beides" : "Rolle"
              }</span>
              ${t.email}
            </p>
            <p style="font-size:12px;margin-top:6px;color:var(--text-light);">Status: ${t.approved ? "Freigeschaltet" : "Wartet auf Freigabe"}</p>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
            <button class="btn btn-success btn-small btn-approve" data-id="${t.id}" data-approved="true">Freigeben</button>
            <button class="btn btn-danger btn-small btn-approve" data-id="${t.id}" data-approved="false">Sperren</button>
          </div>
        </div>
      `).join("");

      elApp.innerHTML = `
        <div class="container">
          <div class="header header-admin">
            <h1>Admin Dashboard <span class="badge">ADMIN</span></h1>
            <p>${STATE.profile.email}</p>
          </div>

          <div class="info-box">
            <p>Angemeldet als <strong>${STATE.profile.email}</strong> (Admin)</p>
          </div>

          <div class="section">
            <h3>Freischaltung & Rollen</h3>

            <div class="form-row three">
              <select id="selTech">
                <option value="">-- Techniker wählen --</option>
                ${STATE.technicians.map(t => `<option value="${t.id}">${t.email}</option>`).join("")}
              </select>
              <input id="inpName" type="text" placeholder="Name setzen (optional)">
              <select id="selTechRole">
                <option value="">-- Technik Rolle --</option>
                <option value="ton">Ton</option>
                <option value="video">Video</option>
                <option value="both">Beides</option>
              </select>
            </div>

            <div class="button-group">
              <button class="btn btn-primary btn-small" id="btnSaveMeta">Name/Rolle speichern</button>
              <button class="btn btn-primary btn-small" id="btnRefresh">Aktualisieren</button>
            </div>

            <div style="margin-top:18px;max-height:360px;overflow:auto;">
              ${techCards || '<p style="color:var(--text-light)">Noch keine Techniker registriert.</p>'}
            </div>
          </div>

          <div class="section">
            <h3>Neuen Plan erstellen</h3>
            <div class="form-row">
              <input id="planStart" type="date">
              <input id="planWeeks" type="number" value="4" min="1" max="12">
            </div>
            <div class="form-group">
              <label>Admin-Kommentar (z.B. Singteam, Abendmahl, etc.)</label>
              <textarea id="adminComment" placeholder="z.B. Singteam mit Kaffee Kuchen" style="min-height: 80px;"></textarea>
            </div>
            <button class="btn btn-primary" id="btnCreatePlan">Plan erstellen</button>
          </div>

          ${plan ? renderAdminPlan() : `
            <div class="section">
              <h3>Kein Plan vorhanden</h3>
              <p style="color:var(--text-light)">Erstelle unten einen neuen Plan.</p>
            </div>
          `}

          <div class="section">
            <button class="btn btn-primary" id="btnLogout">Abmelden</button>
          </div>
        </div>
      `;

      document.getElementById("btnLogout").addEventListener("click", logout);
      document.getElementById("btnRefresh").addEventListener("click", refreshAdmin);
      document.getElementById("btnSaveMeta").addEventListener("click", saveTechMeta);
      document.getElementById("btnCreatePlan").addEventListener("click", createPlan);

      elApp.querySelectorAll(".btn-approve").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          const approved = btn.getAttribute("data-approved") === "true";
          await approveUser(id, approved);
        });
      });

      if (STATE.plan) wireAdminPlanHandlers();
    }

    function renderAdminPlan() {
      const plan = STATE.plan;
      const techs = STATE.technicians.filter(t => t.approved);

      const tableHeader = techs.map(t => `<th>${t.name || t.email}</th>`).join("");

      const rows = STATE.planSundays.map(date => {
        const tds = techs.map(t => {
          const resp = (STATE.responses[t.id] || {})[date];
          const emoji = resp === "green" ? "✅" : resp === "yellow" ? "❓" : resp === "red" ? "❌" : "";
          return `<td class="response-cell">${emoji}</td>`;
        }).join("");
        return `<tr><td class="date-cell">${fmtDateDE(date)}</td>${tds}</tr>`;
      }).join("");

      const techCommentsHtml = STATE.planSundays.map(date => {
        const comments = [];
        techs.forEach(t => {
          const comment = (STATE.techComments[t.id] || {})[date];
          if (comment) comments.push(`<strong>${t.name || t.email}</strong> ${comment}`);
        });
        return `
          <div style="margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid var(--primary);">
            <strong>${fmtDateDE(date)}</strong><br>
            ${comments.length ? comments.map(c => `<div style="font-size: 13px; margin-top: 5px;">${c}</div>`).join("") : '<em style="color: var(--text-light); font-size: 13px;">Keine Sonderwünsche</em>'}
          </div>
        `;
      }).join("");

      const manualSundayOptions = STATE.planSundays.map(d => `<option value="${d}">${fmtDateDE(d)}</option>`).join("");
      const manualTechOptions = techs.map(t => `<option value="${t.id}">${t.name || t.email}</option>`).join("");

      const assignmentsOverview = STATE.planSundays.map(date => {
        const ids = STATE.assignments[date] || [];
        const names = ids.map(id => {
          const t = techs.find(x => x.id === id);
          return t ? (t.name || t.email) : "?";
        }).join(" + ");
        return `
          <div style="background:#f8f9fa;padding:10px;border-radius:8px;margin-bottom:10px;">
            <strong>${fmtDateDE(date)}</strong> ${names || "Noch nicht zugewiesen"}
          </div>
        `;
      }).join("");

      const pubBadge = plan.published ? `<span class="badge">VERÖFFENTLICHT</span>` : `<span class="badge">DRAFT</span>`;
      const pubButton = plan.published ? `` : `<button class="btn btn-success btn-small" id="btnPublishPlan">Plan freigeben</button>`;

      return `
        <div class="section" id="adminPlanSection">
          <h3>Aktueller Plan ${pubBadge} - Status <strong>${plan.status}</strong></h3>
          <p style="color:var(--text-light);font-size:13px;margin-bottom:15px;">
            Erstellt ${new Date(plan.createdat).toLocaleDateString("de-DE")} | ${STATE.planSundays.length} Sonntage
          </p>

          ${plan.admincomment ? `<div class="comment-box"><strong>Admin-Kommentar</strong><p>${plan.admincomment}</p></div>` : ""}

          <div class="plan-table">
            <table>
              <tr>
                <th>Sonntag</th>
                ${tableHeader}
              </tr>
              ${rows}
            </table>
          </div>

          <div class="button-group">
            ${pubButton}
            <button class="btn btn-success btn-small" id="btnAutoAssign">Auto-Zuweisung</button>
            <button class="btn btn-primary btn-small" id="btnCalendarExport">Kalender Export (.ics)</button>
            <button class="btn btn-danger btn-small" id="btnDeletePlan">Plan löschen</button>
          </div>
        </div>

        <div class="section">
          <h3>Sonderwünsche der Techniker</h3>
          ${techCommentsHtml || '<p style="color: var(--text-light);">Noch keine Sonderwünsche eingetragen</p>'}
        </div>

        <div class="section">
          <h3>Manuelle Anpassung</h3>
          <div class="form-row three">
            <select id="manualDate">
              <option value="">-- Sonntag wählen --</option>
              ${manualSundayOptions}
            </select>
            <select id="manualTech">
              <option value="">-- Techniker wählen --</option>
              ${manualTechOptions}
            </select>
            <button class="btn btn-success btn-small" style="width:100%" id="btnManualAdd">Hinzufügen</button>
          </div>
          <div id="manualList"></div>
        </div>

        <div class="section">
          <h3>Zuweisungen Übersicht</h3>
          ${assignmentsOverview}
        </div>
      `;
    }

    function wireAdminPlanHandlers() {
      document.getElementById("btnAutoAssign")?.addEventListener("click", autoAssign);
      document.getElementById("btnDeletePlan")?.addEventListener("click", deletePlan);
      document.getElementById("btnManualAdd")?.addEventListener("click", manualAdd);
      document.getElementById("manualDate")?.addEventListener("change", updateManualList);
      document.getElementById("btnPublishPlan")?.addEventListener("click", publishPlan);
      document.getElementById("btnCalendarExport")?.addEventListener("click", exportCalendar);
      updateManualList();
    }

    async function refreshAdmin() {
      await fetchTechnicians();
      await fetchCurrentPlan(true);
      await fetchResponsesAndAssignments();
      renderAdmin();
    }

    async function approveUser(id, approved) {
      const { error } = await sb.from("profiles").update({ approved }).eq("id", id);
      if (error) return toast("Fehler: " + error.message);
      await refreshAdmin();
    }

    async function saveTechMeta() {
      const id = document.getElementById("selTech").value;
      const name = document.getElementById("inpName").value.trim();
      const techrole = document.getElementById("selTechRole").value;

      if (!id) return toast("Bitte Techniker wählen.");

      const payload = {};
      if (name) payload.name = name;
      if (techrole) payload.techrole = techrole;
      if (Object.keys(payload).length === 0) return toast("Nichts zu speichern.");

      const { error } = await sb.from("profiles").update(payload).eq("id", id);
      if (error) return toast("Fehler: " + error.message);

      await refreshAdmin();
      toast("Gespeichert.");
    }

    async function createPlan() {
      const startStr = document.getElementById("planStart").value;
      const weeks = parseInt(document.getElementById("planWeeks").value, 10);
      const adminComment = document.getElementById("adminComment").value.trim();

      if (!startStr || isNaN(weeks) || weeks < 1) return toast("Startdatum + Wochen eingeben.");

      let current = new Date(startStr + "T12:00:00");
      const day = current.getDay();
      if (day !== 0) current.setDate(current.getDate() + (7 - day));

      const sundays = [];
      for (let i = 0; i < weeks; i++) {
        const y = current.getFullYear();
        const m = String(current.getMonth() + 1).padStart(2, "0");
        const d = String(current.getDate()).padStart(2, "0");
        sundays.push(`${y}-${m}-${d}`);
        current.setDate(current.getDate() + 7);
      }

      const { data: plan, error: e1 } = await sb
        .from("plans")
        .insert([{ status: "responses_pending", createdby: STATE.user.id, admincomment: adminComment }])
        .select("id,status,createdat,createdby,published,admincomment")
        .single();
      if (e1) return toast("Plan Fehler: " + e1.message);

      const rows = sundays.map(s => ({ planid: plan.id, sunday: s }));
      const { error: e2 } = await sb.from("plansundays").insert(rows);
      if (e2) return toast("Sonntage Fehler: " + e2.message);

      toast("Plan erstellt (Draft). Erst nach Freigabe sehen Techniker ihn.");
      await refreshAdmin();
    }

    async function deletePlan() {
      if (!STATE.plan) return;
      if (!confirm("Plan wirklich löschen?")) return;

      const { error } = await sb.from("plans").delete().eq("id", STATE.plan.id);
      if (error) return toast("Fehler: " + error.message);

      toast("Plan gelöscht.");
      await refreshAdmin();
    }

    function updateManualList() {
      const date = document.getElementById("manualDate")?.value;
      const box = document.getElementById("manualList");
      if (!box) return;

      if (!date) {
        box.innerHTML = '<p style="color: var(--text-light); margin-top: 10px;">Bitte zuerst einen Sonntag auswählen.</p>';
        return;
      }

      const techs = STATE.technicians.filter(t => t.approved);
      const ids = STATE.assignments[date] || [];

      if (ids.length === 0) {
        box.innerHTML = '<p style="color: var(--text-light); margin-top: 10px;">Noch niemand zugewiesen.</p>';
        return;
      }

      box.innerHTML = `
        <div style="margin-top:10px;">
          ${ids.map(id => {
            const t = techs.find(x => x.id === id);
            if (!t) return "";
            return `<span class="tech-badge">${t.name || t.email}<span class="remove" data-date="${date}" data-id="${id}">✕</span></span>`;
          }).join("")}
        </div>
      `;

      box.querySelectorAll(".remove").forEach(btn => {
        btn.addEventListener("click", async () => {
          const d = btn.getAttribute("data-date");
          const id = btn.getAttribute("data-id");
          await manualRemove(d, id);
        });
      });
    }

    async function manualAdd() {
      const date = document.getElementById("manualDate")?.value;
      const techId = document.getElementById("manualTech")?.value;
      if (!STATE.plan) return;
      if (!date || !techId) return toast("Sonntag und Techniker wählen.");

      const existing = STATE.assignments[date] || [];
      if (existing.includes(techId)) return toast("Techniker ist schon zugewiesen.");

      const newIds = [...existing, techId];

      const { error } = await sb
        .from("assignments")
        .upsert([{ planid: STATE.plan.id, sunday: date, techids: newIds }], { onConflict: "planid,sunday" });
      if (error) return toast("Fehler: " + error.message);

      await fetchResponsesAndAssignments();
      renderAdmin();
    }

    async function manualRemove(date, techId) {
      if (!STATE.plan) return;
      const existing = STATE.assignments[date] || [];
      const newIds = existing.filter(id => id !== techId);

      const { error } = await sb
        .from("assignments")
        .upsert([{ planid: STATE.plan.id, sunday: date, techids: newIds }], { onConflict: "planid,sunday" });
      if (error) return toast("Fehler: " + error.message);

      await fetchResponsesAndAssignments();
      renderAdmin();
    }

    async function autoAssign() {
      if (!STATE.plan) return;

      const techs = STATE.technicians.filter(t => t.approved);
      const respByTech = STATE.responses;

      function score(tid, date) {
        const r = (respByTech[tid] || {})[date];
        if (r === "green") return 2;
        if (r === "yellow") return 1;
        if (r === "red") return -5;
        return 0;
      }

      for (const date of STATE.planSundays) {
        const ton = techs
          .filter(t => t.techrole === "ton" || t.techrole === "both")
          .map(t => ({ t, s: score(t.id, date) }))
          .sort((a,b) => b.s - a.s)[0]?.t;

        const video = techs
          .filter(t => (t.techrole === "video" || t.techrole === "both") && t.id !== ton?.id)
          .map(t => ({ t, s: score(t.id, date) }))
          .sort((a,b) => b.s - a.s)[0]?.t;

        const ids = [];
        if (ton) ids.push(ton.id);
        if (video) ids.push(video.id);

        const { error } = await sb
          .from("assignments")
          .upsert([{ planid: STATE.plan.id, sunday: date, techids: ids }], { onConflict: "planid,sunday" });

        if (error) return toast("Fehler: " + error.message);
      }

      toast("Auto-Zuweisung fertig.");
      await fetchResponsesAndAssignments();
      renderAdmin();
    }

    function exportCalendar() {
      if (!STATE.plan || !STATE.planSundays.length) return toast("Kein Plan vorhanden.");

      let ical = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//CGH Technik Planer//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:CGH Technik Plan
X-WR-TIMEZONE:Europe/Berlin
BEGIN:VTIMEZONE
TZID:Europe/Berlin
BEGIN:STANDARD
DTSTART:19961027T030000
TZOFFSETFROM:+0200
TZOFFSETTO:+0100
RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU
END:STANDARD
BEGIN:DAYLIGHT
DTSTART:19810329T020000
TZOFFSETFROM:+0100
TZOFFSETTO:+0200
RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=-1SU
END:DAYLIGHT
END:VTIMEZONE
`;

      STATE.planSundays.forEach(date => {
        const ids = STATE.assignments[date] || [];
        const techs = STATE.technicians.filter(t => t.approved);
        const names = ids.map(id => {
          const t = techs.find(x => x.id === id);
          return t ? (t.name || t.email) : "?";
        }).join(", ");

        const d = new Date(date + "T18:00:00");
        const dtstart = d.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";
        const dtend = new Date(d.getTime() + 3 * 60 * 60000).toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";

        ical += `BEGIN:VEVENT
UID:${STATE.plan.id}-${date}@cgh-technik
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, "").split(".")[0]}Z
DTSTART:${dtstart}
DTEND:${dtend}
SUMMARY:CGH Technik - ${fmtDateDE(date)}
DESCRIPTION:Team: ${names || "noch nicht zugewiesen"}
LOCATION:CGH Stuttgart
STATUS:CONFIRMED
SEQUENCE:0
END:VEVENT
`;
      });

      ical += `END:VCALENDAR`;

      const blob = new Blob([ical], { type: "text/calendar;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `CGH-Technik-Plan-${STATE.plan.id}.ics`;
      link.click();
      URL.revokeObjectURL(url);

      toast("Kalender exportiert!");
    }

    async function route() {
      await safeLoadSession();
      if (!STATE.user) return renderLogin();

      await fetchMyProfile();

      if (!STATE.profile) {
        elApp.innerHTML = `
          <div class="container">
            <div class="fatal">
              <h2 style="margin:0 0 8px 0;color:var(--error)">Profil fehlt</h2>
              <p style="margin:0;color:var(--text-light)">
                Dein User existiert, aber es gibt keinen Eintrag in <code>profiles</code>.
              </p>
              <div style="margin-top: 12px;">
                <button class="btn btn-primary" id="btnLogout">Abmelden</button>
              </div>
            </div>
          </div>
        `;
        document.getElementById("btnLogout").addEventListener("click", logout);
        return;
      }

      const isAdmin = STATE.profile.role === "admin";

      if (isAdmin) {
        await fetchTechnicians();
        await fetchCurrentPlan(true);
        await fetchResponsesAndAssignments();
        return renderAdmin();
      }

      if (!STATE.profile.approved) return renderPending();

      await fetchTechnicians();
      await fetchCurrentPlan(false);
      await fetchResponsesAndAssignments();
      return renderTech();
    }

    async function safeRoute() {
      try {
        await route();
      } catch (e) {
        const msg = e?.message ? e.message : String(e);
        elApp.innerHTML = `
          <div class="container">
            <div class="fatal">
              <h2 style="margin:0 0 8px 0;color:var(--error)">Fehler beim Laden</h2>
              <p style="margin:0;color:var(--text-light)">Bitte Screenshot an Jan schicken</p>
              <pre>${msg}</pre>
            </div>
          </div>
        `;
      }
    }

    sb.auth.onAuthStateChange(() => safeRoute());
    safeRoute();
  </script>
</body>
</html>
