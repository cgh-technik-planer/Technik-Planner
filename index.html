<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß CGH Technik Planer</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #208085;
            --admin: #c01530;
            --user: #22a344;
            --bg: #f5f5f5;
            --text: #333;
            --border: #ddd;
            --white: #fff;
            --light: #f9f9f9;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--primary);
            color: var(--white);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 24px;
        }

        header .user-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.5);
            color: var(--white);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .card {
            background: var(--white);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 13px;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(32, 128, 133, 0.1);
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: #1a6b70;
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--light);
        }

        .btn-admin {
            background: var(--admin);
            color: var(--white);
        }

        .btn-admin:hover {
            background: #a01228;
        }

        .btn-export {
            background: #0066cc;
            color: var(--white);
        }

        .btn-export:hover {
            background: #0052a3;
        }

        .btn-delete {
            background: #d32f2f;
            color: var(--white);
        }

        .btn-delete:hover {
            background: #b71c1c;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .assignment-card {
            background: var(--light);
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--primary);
        }

        .assignment-card h3 {
            margin: 0 0 8px 0;
            font-size: 15px;
            color: var(--primary);
        }

        .assignment-card p {
            margin: 4px 0;
            font-size: 13px;
        }

        .color-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .color-btn {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 12px;
        }

        .color-btn.green {
            background: #c8e6c9;
            color: #2e7d32;
            border-color: #81c784;
        }

        .color-btn.yellow {
            background: #fff9c4;
            color: #f57f17;
            border-color: #fbc02d;
        }

        .color-btn.red {
            background: #ffcdd2;
            color: #c62828;
            border-color: #ef5350;
        }

        .color-btn.selected {
            border-width: 3px;
            transform: scale(1.05);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: var(--white);
            padding: 12px 20px;
            border-radius: 4px;
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.error {
            background: #d32f2f;
        }

        .toast.success {
            background: var(--user);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: var(--bg);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: var(--light);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-published {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .status-draft {
            background: #fff9c4;
            color: #f57f17;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--light);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 28px;
            color: var(--primary);
            margin: 0;
        }

        .stat-card p {
            font-size: 12px;
            color: #666;
            margin: 5px 0 0 0;
        }

        .role-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            background: #e3f2fd;
            color: #1976d2;
        }

        .admin-controls {
            background: rgba(192, 21, 48, 0.05);
            border-left: 4px solid var(--admin);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .admin-controls h3 {
            color: var(--admin);
            margin-top: 0;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .two-col {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                gap: 10px;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .color-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- LOGIN -->
    <div id="login-view" style="display:none;">
        <div style="max-width: 400px; margin: 60px auto;">
            <div class="card">
                <h2 style="text-align: center; color: var(--primary); margin-bottom: 30px;">üîß CGH Technik Planer</h2>
                
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="login-email" placeholder="deine@email.de">
                </div>

                <div class="form-group">
                    <label>Passwort</label>
                    <input type="password" id="login-password" placeholder="Passwort">
                </div>

                <button class="btn btn-primary" onclick="handleLogin()" style="width: 100%;">Anmelden</button>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border);">

                <p style="text-align: center; font-size: 12px; margin-bottom: 10px;">Noch kein Konto?</p>
                <button class="btn btn-secondary" onclick="showRegister()" style="width: 100%;">Als Techniker registrieren</button>
            </div>

            <div style="text-align: center; margin-top: 20px; font-size: 12px; color: #666;">
                <p><strong>Admin-Login:</strong></p>
                <p>Email: admin@CGH.de</p>
                <p>Passwort: Technik2026</p>
            </div>
        </div>
    </div>

    <!-- REGISTER -->
    <div id="register-view" style="display:none;">
        <div style="max-width: 400px; margin: 60px auto;">
            <div class="card">
                <h2 style="text-align: center; color: var(--primary); margin-bottom: 30px;">üìù Als Techniker registrieren</h2>
                
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="reg-name" placeholder="Dein Name">
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="reg-email" placeholder="deine@email.de">
                </div>

                <div class="form-group">
                    <label>Passwort (merken!)</label>
                    <input type="password" id="reg-password" placeholder="Dein sicheres Passwort">
                </div>

                <div class="form-group">
                    <label>Rolle</label>
                    <select id="reg-role">
                        <option value="">-- W√§hlen --</option>
                        <option value="üé§ Ton">üé§ Ton</option>
                        <option value="üìπ Video">üìπ Video</option>
                        <option value="üí° Licht">üí° Licht</option>
                        <option value="üñ•Ô∏è Netzwerk">üñ•Ô∏è Netzwerk</option>
                        <option value="üé§üìπ Ton + Video">üé§üìπ Ton + Video</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="handleRegister()" style="width: 100%; margin-bottom: 10px;">Registrieren</button>
                <button class="btn btn-secondary" onclick="showLogin()" style="width: 100%;">Zur√ºck zum Login</button>
            </div>
        </div>
    </div>

    <!-- APP -->
    <div id="app-view" style="display:none;">
        <header>
            <div>
                <h1>üîß CGH Technik Planer</h1>
            </div>
            <div>
                <div class="user-info" id="user-info"></div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('admin')">üìä Admin</button>
            <button class="tab-btn" onclick="switchTab('tech')">üë§ Techniker</button>
        </div>

        <!-- ADMIN TAB -->
        <div id="admin" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="stat-techs">0</h3>
                    <p>Techniker</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-sundays">0</h3>
                    <p>Sonntage</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-assigned">0</h3>
                    <p>Zugewiesen</p>
                </div>
            </div>

            <!-- Admin Controls -->
            <div class="admin-controls">
                <h3>‚öôÔ∏è Plan Management</h3>
                
                <div class="two-col">
                    <div class="form-group">
                        <label>Start-Datum (Sonntag)</label>
                        <input type="date" id="start-date">
                    </div>
                    <div class="form-group">
                        <label>Anzahl Sonntage</label>
                        <input type="number" id="num-sundays" value="4" min="1" max="52">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="createPlan()" style="margin-right: 10px;">üìÖ Plan erstellen</button>
                <button class="btn btn-delete btn-small" onclick="deletePlan()" id="delete-plan-btn" style="display:none;">L√∂schen</button>
            </div>

            <!-- Techniker Management -->
            <div class="card">
                <h3>üë• Techniker verwalten</h3>
                
                <div class="two-col">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="tech-name" placeholder="z.B. Max M√ºller">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="tech-email" placeholder="max@example.de">
                    </div>
                </div>

                <div class="form-group">
                    <label>Rolle</label>
                    <select id="tech-role">
                        <option value="">-- W√§hlen --</option>
                        <option value="üé§ Ton">üé§ Ton</option>
                        <option value="üìπ Video">üìπ Video</option>
                        <option value="üí° Licht">üí° Licht</option>
                        <option value="üñ•Ô∏è Netzwerk">üñ•Ô∏è Netzwerk</option>
                        <option value="üé§üìπ Ton + Video">üé§üìπ Ton + Video</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="addTechnician()" style="margin-bottom: 20px;">‚ûï Techniker hinzuf√ºgen</button>

                <h4 style="margin-top: 20px;">Alle Techniker:</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Rolle</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody id="tech-list"></tbody>
                </table>
            </div>

            <!-- Dashboard -->
            <div class="card">
                <h3>üìã Plan √úbersicht</h3>
                <div id="admin-dashboard"></div>
            </div>
        </div>

        <!-- TECHNIKER TAB -->
        <div id="tech" class="tab-content">
            <div class="card">
                <h3>üìÖ Meine Termine & Export</h3>
                <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                    Hier kannst du sehen, an welchen Terminen du eingeplant bist und den Plan in deinen Kalender exportieren.
                </p>

                <div id="tech-schedule" style="margin-bottom: 20px;"></div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-export" onclick="exportToIcal()">üìÖ In Kalender exportieren (iCal)</button>
                    <button class="btn btn-export" onclick="exportToCsv()">üìä Als CSV exportieren</button>
                </div>
            </div>

            <!-- Verf√ºgbarkeit -->
            <div class="card">
                <h3>‚úã Verf√ºgbarkeit eintragen</h3>
                <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                    üü¢ = Verf√ºgbar | üü° = Eher nicht | üî¥ = Nicht verf√ºgbar
                </p>
                <div id="availability-form"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://orcpugfqltiljnvlitsn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yY3B1Z2ZxbHRpbGp2bml0c24iLCJyb2xlIjoiYW5vbiIsImlhdCI6MTcwNDkwNzEzNywiZXhwIjoxNzM2NDQzMTM3fQ.qlXET4T6Hgu8UIe3b5aocgdItJEBjI3FzEzPZVePti6';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let APP = {
        currentUser: null,
        isAdmin: false,
        plan: null,
        technicians: [],
        availability: {},
        assignments: {}
    };

    // ===== INIT =====
    async function init() {
        try {
            const stored = localStorage.getItem('cgh_tech_user');
            if (stored) {
                APP.currentUser = JSON.parse(stored);
                await loadData();
                showApp();
            } else {
                showLogin();
            }
        } catch (e) {
            console.error('Init error:', e);
            showLogin();
        }
    }

    // ===== LOGIN / REGISTER / LOGOUT =====
    function showLogin() {
        document.getElementById('login-view').style.display = 'block';
        document.getElementById('register-view').style.display = 'none';
        document.getElementById('app-view').style.display = 'none';
    }

    function showRegister() {
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('register-view').style.display = 'block';
        document.getElementById('app-view').style.display = 'none';
    }

    async function handleLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        if (!email || !password) {
            toast('Bitte alle Felder f√ºllen!', 'error');
            return;
        }

        const { data, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('email', email)
            .single();

        if (error || !data) {
            toast('Email nicht bekannt', 'error');
            return;
        }

        const storedPassword = localStorage.getItem('cgh_tech_passwords');
        const passwords = storedPassword ? JSON.parse(storedPassword) : {};

        if (!passwords[email] || passwords[email] !== password) {
            toast('Falsches Passwort!', 'error');
            return;
        }

        APP.currentUser = data;
        APP.isAdmin = data.role === 'admin';
        localStorage.setItem('cgh_tech_user', JSON.stringify(APP.currentUser));

        await loadData();
        showApp();
        toast('‚úÖ Willkommen ' + data.name + '!', 'success');
    }

    async function handleRegister() {
        const name = document.getElementById('reg-name').value;
        const email = document.getElementById('reg-email').value;
        const password = document.getElementById('reg-password').value;
        const role = document.getElementById('reg-role').value;

        if (!name || !email || !password || !role) {
            toast('Bitte alle Felder f√ºllen!', 'error');
            return;
        }

        // Check if email exists
        const { data: existing } = await supabase
            .from('profiles')
            .select('id')
            .eq('email', email);

        if (existing && existing.length > 0) {
            toast('Email existiert bereits!', 'error');
            return;
        }

        // Insert new technician
        const { data: newUser, error } = await supabase
            .from('profiles')
            .insert([
                {
                    name,
                    email,
                    role: 'technician',
                    specialization: role
                }
            ])
            .select()
            .single();

        if (error) {
            toast('Fehler beim Registrieren: ' + error.message, 'error');
            return;
        }

        // Save password locally
        const passwords = JSON.parse(localStorage.getItem('cgh_tech_passwords') || '{}');
        passwords[email] = password;
        localStorage.setItem('cgh_tech_passwords', JSON.stringify(passwords));

        toast('‚úÖ Registrierung erfolgreich! Melde dich jetzt an.', 'success');
        showLogin();
        document.getElementById('login-email').value = email;
    }

    async function loadData() {
        const { data: techs } = await supabase.from('profiles').select('*');
        const { data: planData } = await supabase.from('plans').select('*').single();
        const { data: avail } = await supabase.from('availability').select('*');
        const { data: assign } = await supabase.from('assignments').select('*');

        APP.technicians = techs || [];
        APP.plan = planData || null;
        APP.availability = {};
        APP.assignments = {};

        if (avail) {
            avail.forEach(a => {
                if (!APP.availability[a.sunday_date]) APP.availability[a.sunday_date] = {};
                APP.availability[a.sunday_date][a.technician_id] = a.availability_status;
            });
        }

        if (assign) {
            assign.forEach(a => {
                if (!APP.assignments[a.sunday_date]) APP.assignments[a.sunday_date] = [];
                APP.assignments[a.sunday_date].push(a);
            });
        }

        await renderUI();
    }

    async function showApp() {
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('register-view').style.display = 'none';
        document.getElementById('app-view').style.display = 'block';

        const user = APP.currentUser;
        const roleLabel = APP.isAdmin ? 'üë®‚Äçüíº Admin' : 'üë§ ' + user.specialization;
        document.getElementById('user-info').textContent = `${user.name} (${roleLabel})`;
    }

    function logout() {
        APP.currentUser = null;
        APP.isAdmin = false;
        localStorage.removeItem('cgh_tech_user');
        showLogin();
        document.getElementById('login-email').value = '';
        document.getElementById('login-password').value = '';
    }

    // ===== PLAN MANAGEMENT =====
    async function createPlan() {
        const startDate = document.getElementById('start-date').value;
        const numSundays = parseInt(document.getElementById('num-sundays').value);

        if (!startDate || numSundays < 1) {
            toast('Bitte Startdatum und Anzahl eintragen!', 'error');
            return;
        }

        const start = new Date(startDate);
        if (start.getDay() !== 0) {
            toast('Das Datum ist kein Sonntag!', 'error');
            return;
        }

        const sundays = [];
        for (let i = 0; i < numSundays; i++) {
            const d = new Date(start);
            d.setDate(d.getDate() + i * 7);
            sundays.push(d.toISOString().split('T')[0]);
        }

        // Delete old plan if exists
        if (APP.plan) {
            await supabase.from('availability').delete().neq('sunday_date', '');
            await supabase.from('assignments').delete().neq('sunday_date', '');
            await supabase.from('plans').delete().eq('id', APP.plan.id);
        }

        // Create new plan
        const { data: newPlan, error } = await supabase
            .from('plans')
            .insert([{ sundays: JSON.stringify(sundays), published: false }])
            .select()
            .single();

        if (error) {
            toast('Fehler: ' + error.message, 'error');
            return;
        }

        APP.plan = newPlan;
        APP.availability = {};

        // Create availability entries for all technicians
        const availEntries = [];
        APP.technicians.forEach(tech => {
            sundays.forEach(sunday => {
                availEntries.push({
                    plan_id: newPlan.id,
                    technician_id: tech.id,
                    sunday_date: sunday,
                    availability_status: 'yellow'
                });
            });
        });

        if (availEntries.length > 0) {
            await supabase.from('availability').insert(availEntries);
        }

        await loadData();
        toast('‚úÖ Plan erstellt!', 'success');
    }

    async function deletePlan() {
        if (!confirm('Plan wirklich l√∂schen?')) return;

        if (APP.plan) {
            await supabase.from('availability').delete().neq('sunday_date', '');
            await supabase.from('assignments').delete().neq('sunday_date', '');
            await supabase.from('plans').delete().eq('id', APP.plan.id);
        }

        APP.plan = null;
        APP.availability = {};
        APP.assignments = {};

        await loadData();
        toast('‚úÖ Plan gel√∂scht!', 'success');
    }

    // ===== TECHNICIAN MANAGEMENT =====
    async function addTechnician() {
        const name = document.getElementById('tech-name').value;
        const email = document.getElementById('tech-email').value;
        const role = document.getElementById('tech-role').value;

        if (!name || !email || !role) {
            toast('Bitte alle Felder f√ºllen!', 'error');
            return;
        }

        const { data: existing } = await supabase
            .from('profiles')
            .select('id')
            .eq('email', email);

        if (existing && existing.length > 0) {
            toast('Techniker existiert bereits!', 'error');
            return;
        }

        const { error } = await supabase
            .from('profiles')
            .insert([{ name, email, role: 'technician', specialization: role }]);

        if (error) {
            toast('Fehler: ' + error.message, 'error');
            return;
        }

        document.getElementById('tech-name').value = '';
        document.getElementById('tech-email').value = '';
        document.getElementById('tech-role').value = '';

        await loadData();
        toast('‚úÖ Techniker hinzugef√ºgt!', 'success');
    }

    async function deleteTechnician(techId) {
        if (!confirm('Techniker wirklich l√∂schen?')) return;

        await supabase.from('availability').delete().eq('technician_id', techId);
        await supabase.from('assignments').delete().eq('technician_id', techId);
        await supabase.from('profiles').delete().eq('id', techId);

        await loadData();
        toast('‚úÖ Techniker gel√∂scht!', 'success');
    }

    // ===== AVAILABILITY =====
    async function updateAvailability(techId, sunday, status) {
        const { error } = await supabase
            .from('availability')
            .update({ availability_status: status })
            .eq('technician_id', techId)
            .eq('sunday_date', sunday);

        if (error) console.error(error);

        if (!APP.availability[sunday]) APP.availability[sunday] = {};
        APP.availability[sunday][techId] = status;

        // Auto-assign if admin changed availability
        if (APP.isAdmin) {
            await autoAssignTeam(sunday);
        }
    }

    async function autoAssignTeam(sunday) {
        // Remove old assignments for this sunday
        await supabase.from('assignments').delete().eq('sunday_date', sunday);

        const available = APP.technicians.filter(tech => {
            const status = APP.availability[sunday] && APP.availability[sunday][tech.id];
            return status === 'green';
        });

        if (available.length === 0) return;

        // Select one Ton + one Video if possible
        const ton = available.find(t => t.specialization && t.specialization.includes('Ton'));
        const video = available.find(t => t.specialization && t.specialization.includes('Video'));

        const team = [];
        if (ton) team.push({ technician_id: ton.id, sunday_date: sunday, role: ton.specialization });
        if (video && video.id !== ton?.id) team.push({ technician_id: video.id, sunday_date: sunday, role: video.specialization });
        if (team.length === 0 && available.length > 0) {
            team.push({ technician_id: available[0].id, sunday_date: sunday, role: available[0].specialization });
        }

        if (team.length > 0) {
            await supabase.from('assignments').insert(team);
        }

        await loadData();
    }

    // ===== PUBLISH PLAN =====
    async function publishPlan() {
        if (!APP.plan) return;

        const { error } = await supabase
            .from('plans')
            .update({ published: true })
            .eq('id', APP.plan.id);

        if (error) {
            toast('Fehler: ' + error.message, 'error');
            return;
        }

        APP.plan.published = true;
        await loadData();
        toast('‚úÖ Plan freigegeben!', 'success');
    }

    // ===== EXPORT =====
    function exportToIcal() {
        if (!APP.plan || !APP.currentUser) {
            toast('Kein Plan oder User!', 'error');
            return;
        }

        const sundays = JSON.parse(APP.plan.sundays);
        const assignments = APP.assignments;

        let icalContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//CGH Technik Planer//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:CGH Technik Plan
X-WR-TIMEZONE:Europe/Berlin
X-WR-CALDESC:Technik Plan f√ºr CGH

`;

        sundays.forEach(sunday => {
            const dayAssignments = assignments[sunday] || [];
            const myAssignment = dayAssignments.find(a => a.technician_id === APP.currentUser.id);

            if (myAssignment) {
                const d = new Date(sunday + 'T10:00:00');
                const dtStart = d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                const dtEnd = new Date(d.getTime() + 90 * 60000).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

                const uid = `technik-${APP.currentUser.id}-${sunday}@cgh.local`;
                const techName = APP.currentUser.name || 'Techniker';

                icalContent += `BEGIN:VEVENT
UID:${uid}
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z
DTSTART:${dtStart}
DTEND:${dtEnd}
SUMMARY:CGH Technik - ${myAssignment.role}
DESCRIPTION:Du hast Technik-Dienst. Rolle: ${myAssignment.role}
LOCATION:Christusgemeinde Hemmingen
END:VEVENT

`;
            }
        });

        icalContent += `END:VCALENDAR`;

        const blob = new Blob([icalContent], { type: 'text/calendar' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `CGH-Technik-${APP.currentUser.name}.ics`;
        a.click();
        URL.revokeObjectURL(url);

        toast('‚úÖ iCal exportiert!', 'success');
    }

    function exportToCsv() {
        if (!APP.plan || !APP.currentUser) {
            toast('Kein Plan oder User!', 'error');
            return;
        }

        const sundays = JSON.parse(APP.plan.sundays);
        const assignments = APP.assignments;

        let csv = 'Datum,Rolle,Name\n';

        sundays.forEach(sunday => {
            const dayAssignments = assignments[sunday] || [];
            const myAssignment = dayAssignments.find(a => a.technician_id === APP.currentUser.id);

            if (myAssignment) {
                const d = new Date(sunday);
                const dateStr = d.toLocaleDateString('de-DE');
                csv += `${dateStr},${myAssignment.role},${APP.currentUser.name}\n`;
            }
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `CGH-Technik-${APP.currentUser.name}.csv`;
        a.click();
        URL.revokeObjectURL(url);

        toast('‚úÖ CSV exportiert!', 'success');
    }

    // ===== RENDERING =====
    async function renderUI() {
        if (APP.isAdmin) {
            renderAdminDashboard();
            renderTechnicianList();
            renderAvailabilityAdmin();
        } else {
            renderTechnicianView();
            renderAvailabilityTech();
        }
    }

    function renderAdminDashboard() {
        if (!APP.plan) {
            document.getElementById('admin-dashboard').innerHTML = '<p style="color: #999;">Kein Plan vorhanden. Erstelle einen!</p>';
            document.getElementById('delete-plan-btn').style.display = 'none';
            return;
        }

        document.getElementById('delete-plan-btn').style.display = 'inline-block';

        const sundays = JSON.parse(APP.plan.sundays);
        const assigned = Object.keys(APP.assignments).length;
        const status = APP.plan.published ? '‚úÖ Ver√∂ffentlicht' : '‚è≥ Entwurf';

        document.getElementById('stat-techs').textContent = APP.technicians.length;
        document.getElementById('stat-sundays').textContent = sundays.length;
        document.getElementById('stat-assigned').textContent = assigned;

        let html = `<div class="status-badge ${APP.plan.published ? 'status-published' : 'status-draft'}">${status}</div>`;

        if (!APP.plan.published) {
            html += `<button class="btn btn-primary btn-small" onclick="publishPlan()" style="margin-left: 10px;">‚úÖ Plan freigeben</button>`;
        }

        html += '<div class="grid" style="margin-top: 20px;">';

        sundays.forEach(sunday => {
            const d = new Date(sunday);
            const dateStr = d.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' });
            const dayAssignments = APP.assignments[sunday] || [];

            html += `<div class="assignment-card">
                <h3>${dateStr}</h3>
                <p><strong>Zugewiesen:</strong> ${dayAssignments.length > 0 ? dayAssignments.length : 'Keine'}</p>`;

            dayAssignments.forEach(a => {
                const tech = APP.technicians.find(t => t.id === a.technician_id);
                html += `<p>üë§ ${tech?.name} (${a.role})</p>`;
            });

            html += `</div>`;
        });

        html += '</div>';
        document.getElementById('admin-dashboard').innerHTML = html;
    }

    function renderTechnicianList() {
        let html = '';
        APP.technicians.forEach(tech => {
            if (tech.role !== 'admin') {
                html += `<tr>
                    <td>${tech.name}</td>
                    <td>${tech.email}</td>
                    <td><span class="role-badge">${tech.specialization}</span></td>
                    <td><button class="btn btn-delete btn-small" onclick="deleteTechnician('${tech.id}')">L√∂schen</button></td>
                </tr>`;
            }
        });
        document.getElementById('tech-list').innerHTML = html;
    }

    function renderAvailabilityAdmin() {
        if (!APP.plan) return;

        const sundays = JSON.parse(APP.plan.sundays);
        let html = '<table><thead><tr><th>Techniker</th>';

        sundays.forEach(sunday => {
            const d = new Date(sunday);
            const dateStr = d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
            html += `<th>${dateStr}</th>`;
        });

        html += '</tr></thead><tbody>';

        // Add technician rows
        APP.technicians.forEach(tech => {
            if (tech.role !== 'admin') {
                html += `<tr><td><strong>${tech.name}</strong></td>`;
                sundays.forEach(sunday => {
                    const status = APP.availability[sunday] && APP.availability[sunday][tech.id] || 'yellow';
                    const colors = { green: 'üü¢', yellow: 'üü°', red: 'üî¥' };
                    html += `<td style="text-align: center;">
                        <div class="color-group">
                            <button class="color-btn green ${status === 'green' ? 'selected' : ''}" onclick="updateAvailability('${tech.id}', '${sunday}', 'green')">üü¢</button>
                            <button class="color-btn yellow ${status === 'yellow' ? 'selected' : ''}" onclick="updateAvailability('${tech.id}', '${sunday}', 'yellow')">üü°</button>
                            <button class="color-btn red ${status === 'red' ? 'selected' : ''}" onclick="updateAvailability('${tech.id}', '${sunday}', 'red')">üî¥</button>
                        </div>
                    </td>`;
                });
                html += '</tr>';
            }
        });

        // Add ADMIN row
        html += `<tr style="background: rgba(192, 21, 48, 0.1); font-weight: bold;"><td>üë®‚Äçüíº Admin (${APP.currentUser.name})</td>`;
        sundays.forEach(sunday => {
            const status = APP.availability[sunday] && APP.availability[sunday][APP.currentUser.id] || 'yellow';
            html += `<td style="text-align: center;">
                <div class="color-group">
                    <button class="color-btn green ${status === 'green' ? 'selected' : ''}" onclick="updateAvailability('${APP.currentUser.id}', '${sunday}', 'green')">üü¢</button>
                    <button class="color-btn yellow ${status === 'yellow' ? 'selected' : ''}" onclick="updateAvailability('${APP.currentUser.id}', '${sunday}', 'yellow')">üü°</button>
                    <button class="color-btn red ${status === 'red' ? 'selected' : ''}" onclick="updateAvailability('${APP.currentUser.id}', '${sunday}', 'red')">üî¥</button>
                </div>
            </td>`;
        });
        html += '</tr></tbody></table>';

        // Add a special card explaining this
        const cardHtml = `
            <div class="admin-controls" style="margin-top: 20px;">
                <h3>üë®‚Äçüíº Admin Selbsteintrag</h3>
                <p style="font-size: 13px; margin-bottom: 10px;">
                    Als Admin kannst du dich auch selbst f√ºr Termine eintragen und bist dann in der Zuweisung mit dabei. 
                    Nutze die Buttons in deiner Reihe (unten), um deine Verf√ºgbarkeit zu setzen.
                </p>
                <p style="font-size: 12px; color: #666;">
                    üü¢ Verf√ºgbar | üü° Eher nicht | üî¥ Nicht verf√ºgbar
                </p>
            </div>
            ${html}
        `;

        document.getElementById('availability-form').innerHTML = cardHtml;
    }

    function renderTechnicianView() {
        if (!APP.plan || !APP.plan.published) {
            document.getElementById('tech-schedule').innerHTML = '<p style="color: #999;">Plan noch nicht freigegeben.</p>';
            document.getElementById('availability-form').innerHTML = '';
            return;
        }

        const sundays = JSON.parse(APP.plan.sundays);
        const assignments = APP.assignments;

        let html = '<div class="grid">';

        sundays.forEach(sunday => {
            const d = new Date(sunday);
            const dateStr = d.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit', year: '2-digit' });
            const dayAssignments = assignments[sunday] || [];
            const myAssignment = dayAssignments.find(a => a.technician_id === APP.currentUser.id);

            const bgColor = myAssignment ? '#c8e6c9' : '#f5f5f5';
            const status = myAssignment ? `‚úÖ ${myAssignment.role}` : '‚ùå Nicht eingeplant';

            html += `<div class="assignment-card" style="background: ${bgColor}; border-left-color: ${myAssignment ? '#4caf50' : '#999'};">
                <h3>${dateStr}</h3>
                <p><strong>${status}</strong></p>
            </div>`;
        });

        html += '</div>';
        document.getElementById('tech-schedule').innerHTML = html;
    }

    function renderAvailabilityTech() {
        if (!APP.plan) {
            document.getElementById('availability-form').innerHTML = '<p style="color: #999;">Kein Plan vorhanden.</p>';
            return;
        }

        const sundays = JSON.parse(APP.plan.sundays);
        let html = '<table><thead><tr><th>Datum</th><th>Verf√ºgbarkeit</th></tr></thead><tbody>';

        sundays.forEach(sunday => {
            const d = new Date(sunday);
            const dateStr = d.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' });
            const status = APP.availability[sunday] && APP.availability[sunday][APP.currentUser.id] || 'yellow';

            html += `<tr>
                <td>${dateStr}</td>
                <td style="text-align: center;">
                    <div class="color-group">
                        <button class="color-btn green ${status === 'green' ? 'selected' : ''}" onclick="updateAvailability('${APP.currentUser.id}', '${sunday}', 'green')">üü¢ Ja</button>
                        <button class="color-btn yellow ${status === 'yellow' ? 'selected' : ''}" onclick="updateAvailability('${APP.currentUser.id}', '${sunday}', 'yellow')">üü° Eher nicht</button>
                        <button class="color-btn red ${status === 'red' ? 'selected' : ''}" onclick="updateAvailability('${APP.currentUser.id}', '${sunday}', 'red')">üî¥ Nein</button>
                    </div>
                </td>
            </tr>`;
        });

        html += '</tbody></table>';
        document.getElementById('availability-form').innerHTML = html;
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tab).classList.add('active');
        event.target.classList.add('active');
    }

    function toast(msg, type = 'info') {
        const el = document.createElement('div');
        el.className = 'toast ' + (type === 'error' ? 'error' : type === 'success' ? 'success' : '');
        el.textContent = msg;
        document.body.appendChild(el);

        setTimeout(() => el.remove(), 3000);
    }

    // ===== INIT =====
    init();
</script>

</body>
</html>
