<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß CGH Technik Planer</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #208085;
            --admin: #c01530;
            --user: #22a344;
            --bg: #f5f5f5;
            --text: #333;
            --border: #ddd;
            --white: #fff;
            --light: #f9f9f9;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--primary);
            color: var(--white);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 24px;
        }

        header .user-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.5);
            color: var(--white);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 15px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--white);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 13px;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(32, 128, 133, 0.1);
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: #1a6b70;
        }

        .btn-delete {
            background: #d32f2f;
            color: var(--white);
        }

        .btn-delete:hover {
            background: #b71c1c;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-export {
            background: #0066cc;
            color: var(--white);
        }

        .btn-export:hover {
            background: #0052a3;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .assignment-card {
            background: var(--light);
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--primary);
        }

        .assignment-card h3 {
            margin: 0 0 8px 0;
            font-size: 15px;
            color: var(--primary);
        }

        .assignment-card p {
            margin: 4px 0;
            font-size: 13px;
        }

        .color-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .color-btn {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 12px;
        }

        .color-btn.green {
            background: #c8e6c9;
            color: #2e7d32;
            border-color: #81c784;
        }

        .color-btn.yellow {
            background: #fff9c4;
            color: #f57f17;
            border-color: #fbc02d;
        }

        .color-btn.red {
            background: #ffcdd2;
            color: #c62828;
            border-color: #ef5350;
        }

        .color-btn.selected {
            border-width: 3px;
            transform: scale(1.05);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: var(--white);
            padding: 12px 20px;
            border-radius: 4px;
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.error {
            background: #d32f2f;
        }

        .toast.success {
            background: var(--user);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: var(--bg);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: var(--light);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-published {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .status-draft {
            background: #fff9c4;
            color: #f57f17;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--light);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 28px;
            color: var(--primary);
            margin: 0;
        }

        .stat-card p {
            font-size: 12px;
            color: #666;
            margin: 5px 0 0 0;
        }

        .role-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            background: #e3f2fd;
            color: #1976d2;
        }

        .admin-controls {
            background: rgba(192, 21, 48, 0.05);
            border-left: 4px solid var(--admin);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .admin-controls h3 {
            color: var(--admin);
            margin-top: 0;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .login-form {
            max-width: 400px;
            margin: 60px auto;
        }

        @media (max-width: 768px) {
            .two-col {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                gap: 10px;
            }

            .tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- LOGIN VIEW -->
    <div id="login-view">
        <div class="login-form">
            <div class="card">
                <h2 style="text-align: center; color: var(--primary); margin-bottom: 30px;">üîß CGH Technik Planer</h2>
                
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="login-email" placeholder="deine@email.de">
                </div>

                <div class="form-group">
                    <label>Passwort</label>
                    <input type="password" id="login-password" placeholder="Passwort">
                </div>

                <button class="btn btn-primary" onclick="handleLogin()" style="width: 100%; margin-bottom: 10px;">Anmelden</button>
                <button class="btn" onclick="showRegister()" style="width: 100%; background: var(--bg); border: 1px solid var(--border);">Als Techniker registrieren</button>
            </div>

            <div style="text-align: center; margin-top: 20px; font-size: 12px; color: #666;">
                <p><strong>Test-Admin:</strong></p>
                <p>Email: admin@cgh.de | Passwort: Technik2026</p>
            </div>
        </div>
    </div>

    <!-- APP VIEW -->
    <div id="app-view" style="display:none;">
        <header>
            <div>
                <h1>üîß CGH Technik Planer</h1>
            </div>
            <div style="display: flex; align-items: center;">
                <div class="user-info" id="user-info"></div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('admin')">üìä Admin</button>
            <button class="tab-btn" onclick="switchTab('tech')">üë§ Techniker</button>
        </div>

        <!-- ADMIN TAB -->
        <div id="admin" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="stat-techs">0</h3>
                    <p>Techniker</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-sundays">0</h3>
                    <p>Sonntage</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-assigned">0</h3>
                    <p>Zugewiesen</p>
                </div>
            </div>

            <!-- Plan Management -->
            <div class="admin-controls">
                <h3>‚öôÔ∏è Plan Management</h3>
                
                <div class="two-col">
                    <div class="form-group">
                        <label>Start-Datum (Sonntag)</label>
                        <input type="date" id="start-date">
                    </div>
                    <div class="form-group">
                        <label>Anzahl Sonntage</label>
                        <input type="number" id="num-sundays" value="4" min="1" max="52">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="createPlan()" style="margin-right: 10px;">üìÖ Plan erstellen</button>
                <button class="btn btn-delete btn-small" onclick="deletePlan()" id="delete-plan-btn" style="display:none;">L√∂schen</button>
            </div>

            <!-- Techniker Management -->
            <div class="card">
                <h3>üë• Techniker verwalten</h3>
                
                <div class="two-col">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="tech-name" placeholder="z.B. Max M√ºller">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="tech-email" placeholder="max@example.de">
                    </div>
                </div>

                <div class="form-group">
                    <label>Rolle</label>
                    <select id="tech-role">
                        <option value="">-- W√§hlen --</option>
                        <option value="üé§ Ton">üé§ Ton</option>
                        <option value="üìπ Video">üìπ Video</option>
                        <option value="üí° Licht">üí° Licht</option>
                        <option value="üñ•Ô∏è Netzwerk">üñ•Ô∏è Netzwerk</option>
                        <option value="üé§üìπ Ton + Video">üé§üìπ Ton + Video</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="addTechnician()" style="margin-bottom: 20px;">‚ûï Techniker hinzuf√ºgen</button>

                <h4 style="margin-top: 20px;">Alle Techniker:</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Rolle</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody id="tech-list"></tbody>
                </table>
            </div>

            <!-- Dashboard -->
            <div class="card">
                <h3>üìã Plan √úbersicht</h3>
                <div id="admin-dashboard"></div>
            </div>

            <!-- Availability Grid -->
            <div class="card">
                <h3>‚úã Verf√ºgbarkeit Management</h3>
                <div id="availability-admin"></div>
            </div>
        </div>

        <!-- TECHNIKER TAB -->
        <div id="tech" class="tab-content">
            <div class="card">
                <h3>üìÖ Meine Termine</h3>
                <div id="tech-schedule"></div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                    <button class="btn btn-export" onclick="exportToIcal()">üìÖ iCal Export</button>
                    <button class="btn btn-export" onclick="exportToCsv()">üìä CSV Export</button>
                </div>
            </div>

            <div class="card">
                <h3>‚úã Meine Verf√ºgbarkeit</h3>
                <div id="availability-tech"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://orcpugfqltiljnvlitsn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yY3B1Z2ZxbHRpbGp2bml0c24iLCJyb2xlIjoiYW5vbiIsImlhdCI6MTcwNDkwNzEzNywiZXhwIjoxNzM2NDQzMTM3fQ.qlXET4T6Hgu8UIe3b5aocgdItJEBjI3FzEzPZVePti6';

    let supabase = null;
    let currentUser = null;
    let isAdmin = false;
    let appData = {
        plan: null,
        technicians: [],
        availability: {},
        assignments: {}
    };

    async function initSupabase() {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const stored = localStorage.getItem('cgh_user');
        if (stored) {
            currentUser = JSON.parse(stored);
            isAdmin = currentUser.role === 'admin';
            await loadData();
            showApp();
        } else {
            showLogin();
        }
    }

    function showLogin() {
        document.getElementById('login-view').style.display = 'block';
        document.getElementById('app-view').style.display = 'none';
    }

    async function showApp() {
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('app-view').style.display = 'block';
        const roleLabel = isAdmin ? 'üë®‚Äçüíº Admin' : 'üë§ ' + (currentUser.specialization || 'Techniker');
        document.getElementById('user-info').textContent = currentUser.name + ' (' + roleLabel + ')';
        
        if (!isAdmin) {
            document.querySelector('.tab-btn:nth-child(1)').style.display = 'none';
        }
    }

    function showRegister() {
        const name = prompt('Name:');
        if (!name) return;
        const email = prompt('Email:');
        if (!email) return;
        const password = prompt('Passwort:');
        if (!password) return;
        
        supabase.from('profiles').insert([{ 
            name, 
            email, 
            role: 'technician',
            specialization: 'üé§ Ton'
        }]).then(() => {
            const passwords = JSON.parse(localStorage.getItem('cgh_passwords') || '{}');
            passwords[email] = password;
            localStorage.setItem('cgh_passwords', JSON.stringify(passwords));
            toast('Registriert! Jetzt anmelden.', 'success');
            showLogin();
            document.getElementById('login-email').value = email;
        }).catch(e => toast('Fehler: ' + e.message, 'error'));
    }

    async function handleLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        if (!email || !password) {
            toast('Bitte alle Felder ausf√ºllen!', 'error');
            return;
        }

        const { data } = await supabase.from('profiles').select('*').eq('email', email).single();
        if (!data) {
            toast('Email nicht gefunden', 'error');
            return;
        }

        const passwords = JSON.parse(localStorage.getItem('cgh_passwords') || '{}');
        if (passwords[email] !== password) {
            toast('Falsches Passwort!', 'error');
            return;
        }

        currentUser = data;
        isAdmin = data.role === 'admin';
        localStorage.setItem('cgh_user', JSON.stringify(data));
        await loadData();
        showApp();
        toast('‚úÖ Willkommen ' + data.name + '!', 'success');
    }

    function logout() {
        currentUser = null;
        localStorage.removeItem('cgh_user');
        document.getElementById('login-email').value = '';
        document.getElementById('login-password').value = '';
        showLogin();
    }

    async function loadData() {
        const { data: techs } = await supabase.from('profiles').select('*');
        const { data: plans } = await supabase.from('plans').select('*').single().catch(() => ({ data: null }));
        const { data: avail } = await supabase.from('availability').select('*');
        const { data: assign } = await supabase.from('assignments').select('*');

        appData.technicians = techs || [];
        appData.plan = plans || null;
        appData.availability = {};
        appData.assignments = {};

        if (avail) {
            avail.forEach(a => {
                if (!appData.availability[a.sunday_date]) appData.availability[a.sunday_date] = {};
                appData.availability[a.sunday_date][a.technician_id] = a.availability_status;
            });
        }

        if (assign) {
            assign.forEach(a => {
                if (!appData.assignments[a.sunday_date]) appData.assignments[a.sunday_date] = [];
                appData.assignments[a.sunday_date].push(a);
            });
        }

        renderUI();
    }

    async function createPlan() {
        const startDate = document.getElementById('start-date').value;
        const numSundays = parseInt(document.getElementById('num-sundays').value);

        if (!startDate || numSundays < 1) {
            toast('Bitte Startdatum eingeben!', 'error');
            return;
        }

        const start = new Date(startDate);
        if (start.getDay() !== 0) {
            toast('Das Datum ist kein Sonntag!', 'error');
            return;
        }

        const sundays = [];
        for (let i = 0; i < numSundays; i++) {
            const d = new Date(start);
            d.setDate(d.getDate() + i * 7);
            sundays.push(d.toISOString().split('T')[0]);
        }

        if (appData.plan) {
            await supabase.from('availability').delete().neq('sunday_date', '');
            await supabase.from('assignments').delete().neq('sunday_date', '');
            await supabase.from('plans').delete().eq('id', appData.plan.id);
        }

        const { data: newPlan } = await supabase.from('plans').insert([{ sundays: JSON.stringify(sundays), published: false }]).select().single();
        
        appData.plan = newPlan;
        appData.availability = {};

        const availEntries = [];
        appData.technicians.forEach(tech => {
            sundays.forEach(sunday => {
                availEntries.push({
                    plan_id: newPlan.id,
                    technician_id: tech.id,
                    sunday_date: sunday,
                    availability_status: 'yellow'
                });
            });
        });

        if (availEntries.length > 0) {
            await supabase.from('availability').insert(availEntries);
        }

        await loadData();
        toast('‚úÖ Plan erstellt!', 'success');
    }

    async function deletePlan() {
        if (!confirm('Plan wirklich l√∂schen?')) return;
        
        if (appData.plan) {
            await supabase.from('availability').delete().neq('sunday_date', '');
            await supabase.from('assignments').delete().neq('sunday_date', '');
            await supabase.from('plans').delete().eq('id', appData.plan.id);
        }

        appData.plan = null;
        await loadData();
        toast('‚úÖ Plan gel√∂scht!', 'success');
    }

    async function addTechnician() {
        const name = document.getElementById('tech-name').value;
        const email = document.getElementById('tech-email').value;
        const role = document.getElementById('tech-role').value;

        if (!name || !email || !role) {
            toast('Bitte alle Felder ausf√ºllen!', 'error');
            return;
        }

        const { data: existing } = await supabase.from('profiles').select('id').eq('email', email);
        if (existing && existing.length > 0) {
            toast('Techniker existiert bereits!', 'error');
            return;
        }

        await supabase.from('profiles').insert([{ name, email, role: 'technician', specialization: role }]);
        
        document.getElementById('tech-name').value = '';
        document.getElementById('tech-email').value = '';
        document.getElementById('tech-role').value = '';

        await loadData();
        toast('‚úÖ Techniker hinzugef√ºgt!', 'success');
    }

    async function deleteTechnician(techId) {
        if (!confirm('Techniker l√∂schen?')) return;
        
        await supabase.from('availability').delete().eq('technician_id', techId);
        await supabase.from('assignments').delete().eq('technician_id', techId);
        await supabase.from('profiles').delete().eq('id', techId);

        await loadData();
        toast('‚úÖ Techniker gel√∂scht!', 'success');
    }

    async function updateAvailability(techId, sunday, status) {
        await supabase.from('availability').update({ availability_status: status }).eq('technician_id', techId).eq('sunday_date', sunday);
        
        if (!appData.availability[sunday]) appData.availability[sunday] = {};
        appData.availability[sunday][techId] = status;

        if (isAdmin) {
            await autoAssignTeam(sunday);
        }
    }

    async function autoAssignTeam(sunday) {
        await supabase.from('assignments').delete().eq('sunday_date', sunday);

        const available = appData.technicians.filter(tech => {
            const status = appData.availability[sunday] && appData.availability[sunday][tech.id];
            return status === 'green';
        });

        if (available.length === 0) return;

        const ton = available.find(t => t.specialization && t.specialization.includes('Ton'));
        const video = available.find(t => t.specialization && t.specialization.includes('Video'));

        const team = [];
        if (ton) team.push({ technician_id: ton.id, sunday_date: sunday, role: ton.specialization });
        if (video && video.id !== ton?.id) team.push({ technician_id: video.id, sunday_date: sunday, role: video.specialization });
        if (team.length === 0 && available.length > 0) {
            team.push({ technician_id: available[0].id, sunday_date: sunday, role: available[0].specialization });
        }

        if (team.length > 0) {
            await supabase.from('assignments').insert(team);
        }

        await loadData();
    }

    async function publishPlan() {
        if (!appData.plan) return;
        
        await supabase.from('plans').update({ published: true }).eq('id', appData.plan.id);
        appData.plan.published = true;
        renderUI();
        toast('‚úÖ Plan freigegeben!', 'success');
    }

    function exportToIcal() {
        if (!appData.plan) {
            toast('Kein Plan vorhanden!', 'error');
            return;
        }

        const sundays = JSON.parse(appData.plan.sundays);
        let ical = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//CGH//EN\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\nX-WR-CALNAME:CGH Technik\n\n`;

        sundays.forEach(sunday => {
            const assignment = (appData.assignments[sunday] || []).find(a => a.technician_id === currentUser.id);
            if (assignment) {
                const d = new Date(sunday + 'T10:00:00');
                const dtStart = d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                const dtEnd = new Date(d.getTime() + 90 * 60000).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                ical += `BEGIN:VEVENT\nDTSTART:${dtStart}\nDTEND:${dtEnd}\nSUMMARY:CGH Technik - ${assignment.role}\nEND:VEVENT\n\n`;
            }
        });

        ical += `END:VCALENDAR`;

        const blob = new Blob([ical], { type: 'text/calendar' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `CGH-${currentUser.name}.ics`;
        a.click();
        URL.revokeObjectURL(url);
        toast('‚úÖ iCal exportiert!', 'success');
    }

    function exportToCsv() {
        if (!appData.plan) {
            toast('Kein Plan vorhanden!', 'error');
            return;
        }

        const sundays = JSON.parse(appData.plan.sundays);
        let csv = 'Datum,Rolle,Name\n';

        sundays.forEach(sunday => {
            const assignment = (appData.assignments[sunday] || []).find(a => a.technician_id === currentUser.id);
            if (assignment) {
                const d = new Date(sunday);
                csv += `${d.toLocaleDateString('de-DE')},${assignment.role},${currentUser.name}\n`;
            }
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `CGH-${currentUser.name}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        toast('‚úÖ CSV exportiert!', 'success');
    }

    function renderUI() {
        if (isAdmin) {
            renderAdminDashboard();
            renderTechnicianList();
            renderAvailabilityAdmin();
        } else {
            renderTechnicianSchedule();
            renderAvailabilityTech();
        }
    }

    function renderAdminDashboard() {
        if (!appData.plan) {
            document.getElementById('admin-dashboard').innerHTML = '<p style="color: #999;">Kein Plan vorhanden. Erstelle einen!</p>';
            document.getElementById('delete-plan-btn').style.display = 'none';
            return;
        }

        document.getElementById('delete-plan-btn').style.display = 'inline-block';
        const sundays = JSON.parse(appData.plan.sundays);
        const assigned = Object.keys(appData.assignments).length;
        const status = appData.plan.published ? '‚úÖ Ver√∂ffentlicht' : '‚è≥ Entwurf';

        document.getElementById('stat-techs').textContent = appData.technicians.length;
        document.getElementById('stat-sundays').textContent = sundays.length;
        document.getElementById('stat-assigned').textContent = assigned;

        let html = `<div class="status-badge ${appData.plan.published ? 'status-published' : 'status-draft'}">${status}</div>`;
        if (!appData.plan.published) {
            html += `<button class="btn btn-primary btn-small" onclick="publishPlan()" style="margin-left: 10px;">‚úÖ Plan freigeben</button>`;
        }

        html += '<div class="grid" style="margin-top: 20px;">';
        sundays.forEach(sunday => {
            const d = new Date(sunday);
            const dateStr = d.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' });
            const dayAssignments = appData.assignments[sunday] || [];
            
            html += `<div class="assignment-card"><h3>${dateStr}</h3><p><strong>Zugewiesen:</strong> ${dayAssignments.length || 'Keine'}</p>`;
            dayAssignments.forEach(a => {
                const tech = appData.technicians.find(t => t.id === a.technician_id);
                html += `<p>üë§ ${tech?.name} (${a.role})</p>`;
            });
            html += `</div>`;
        });
        html += '</div>';
        document.getElementById('admin-dashboard').innerHTML = html;
    }

    function renderTechnicianList() {
        let html = '';
        appData.technicians.forEach(tech => {
            if (tech.role !== 'admin') {
                html += `<tr><td>${tech.name}</td><td>${tech.email}</td><td><span class="role-badge">${tech.specialization}</span></td><td><button class="btn btn-delete btn-small" onclick="deleteTechnician('${tech.id}')">L√∂schen</button></td></tr>`;
            }
        });
        document.getElementById('tech-list').innerHTML = html;
    }

    function renderAvailabilityAdmin() {
        if (!appData.plan) return;
        
        const sundays = JSON.parse(appData.plan.sundays);
        let html = '<table><thead><tr><th>Techniker</th>';
        sundays.forEach(sunday => {
            const d = new Date(sunday);
            html += `<th>${d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' })}</th>`;
        });
        html += '</tr></thead><tbody>';

        appData.technicians.forEach(tech => {
            if (tech.role !== 'admin') {
                html += `<tr><td><strong>${tech.name}</strong></td>`;
                sundays.forEach(sunday => {
                    const status = appData.availability[sunday]?.[tech.id] || 'yellow';
                    html += `<td style="text-align: center;"><div class="color-group"><button class="color-btn green ${status === 'green' ? 'selected' : ''}" onclick="updateAvailability('${tech.id}', '${sunday}', 'green')">üü¢</button><button class="color-btn yellow ${status === 'yellow' ? 'selected' : ''}" onclick="updateAvailability('${tech.id}', '${sunday}', 'yellow')">üü°</button><button class="color-btn red ${status === 'red' ? 'selected' : ''}" onclick="updateAvailability('${tech.id}', '${sunday}', 'red')">üî¥</button></div></td>`;
                });
                html += '</tr>';
            }
        });

        html += `<tr style="background: rgba(192, 21, 48, 0.1); font-weight: bold;"><td>üë®‚Äçüíº Admin</td>`;
        sundays.forEach(sunday => {
            const status = appData.availability[sunday]?.[currentUser.id] || 'yellow';
            html += `<td style="text-align: center;"><div class="color-group"><button class="color-btn green ${status === 'green' ? 'selected' : ''}" onclick="updateAvailability('${currentUser.id}', '${sunday}', 'green')">üü¢</button><button class="color-btn yellow ${status === 'yellow' ? 'selected' : ''}" onclick="updateAvailability('${currentUser.id}', '${sunday}', 'yellow')">üü°</button><button class="color-btn red ${status === 'red' ? 'selected' : ''}" onclick="updateAvailability('${currentUser.id}', '${sunday}', 'red')">üî¥</button></div></td>`;
        });
        html += '</tr></tbody></table>';
        document.getElementById('availability-admin').innerHTML = html;
    }

    function renderTechnicianSchedule() {
        if (!appData.plan || !appData.plan.published) {
            document.getElementById('tech-schedule').innerHTML = '<p style="color: #999;">Plan noch nicht freigegeben.</p>';
            return;
        }

        const sundays = JSON.parse(appData.plan.sundays);
        let html = '<div class="grid">';
        sundays.forEach(sunday => {
            const d = new Date(sunday);
            const dateStr = d.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' });
            const assignment = (appData.assignments[sunday] || []).find(a => a.technician_id === currentUser.id);
            const status = assignment ? `‚úÖ ${assignment.role}` : '‚ùå Nicht eingeplant';
            const bgColor = assignment ? '#c8e6c9' : '#f5f5f5';
            
            html += `<div class="assignment-card" style="background: ${bgColor}; border-left-color: ${assignment ? '#4caf50' : '#999'};"><h3>${dateStr}</h3><p><strong>${status}</strong></p></div>`;
        });
        html += '</div>';
        document.getElementById('tech-schedule').innerHTML = html;
    }

    function renderAvailabilityTech() {
        if (!appData.plan) {
            document.getElementById('availability-tech').innerHTML = '<p style="color: #999;">Kein Plan vorhanden.</p>';
            return;
        }

        const sundays = JSON.parse(appData.plan.sundays);
        let html = '<table><thead><tr><th>Datum</th><th>Verf√ºgbarkeit</th></tr></thead><tbody>';

        sundays.forEach(sunday => {
            const d = new Date(sunday);
            const dateStr = d.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' });
            const status = appData.availability[sunday]?.[currentUser.id] || 'yellow';
            
            html += `<tr><td>${dateStr}</td><td style="text-align: center;"><div class="color-group"><button class="color-btn green ${status === 'green' ? 'selected' : ''}" onclick="updateAvailability('${currentUser.id}', '${sunday}', 'green')">üü¢ Ja</button><button class="color-btn yellow ${status === 'yellow' ? 'selected' : ''}" onclick="updateAvailability('${currentUser.id}', '${sunday}', 'yellow')">üü° Eher nicht</button><button class="color-btn red ${status === 'red' ? 'selected' : ''}" onclick="updateAvailability('${currentUser.id}', '${sunday}', 'red')">üî¥ Nein</button></div></td></tr>`;
        });

        html += '</tbody></table>';
        document.getElementById('availability-tech').innerHTML = html;
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
        event.target.classList.add('active');
    }

    function toast(msg, type = 'info') {
        const el = document.createElement('div');
        el.className = 'toast ' + (type === 'error' ? 'error' : type === 'success' ? 'success' : '');
        el.textContent = msg;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 3000);
    }

    // Erstelle Admin-Account wenn nicht vorhanden
    async function ensureAdmin() {
        const { data: admin } = await supabase.from('profiles').select('id').eq('email', 'admin@cgh.de').single().catch(() => ({ data: null }));
        if (!admin) {
            await supabase.from('profiles').insert([{
                name: 'Admin',
                email: 'admin@cgh.de',
                role: 'admin',
                specialization: 'üé§ Admin'
            }]).catch(console.error);
            
            const passwords = JSON.parse(localStorage.getItem('cgh_passwords') || '{}');
            passwords['admin@cgh.de'] = 'Technik2026';
            localStorage.setItem('cgh_passwords', JSON.stringify(passwords));
        }
    }

    initSupabase();
    ensureAdmin();
</script>

</body>
</html>
